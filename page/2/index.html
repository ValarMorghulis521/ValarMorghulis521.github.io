<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Page 2 | Contunued Story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta name="description" content="Stay Hungry Stay Foolish">
<meta property="og:type" content="website">
<meta property="og:title" content="Contunued Story">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Contunued Story">
<meta property="og:description" content="Stay Hungry Stay Foolish">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Contunued Story">
<meta name="twitter:description" content="Stay Hungry Stay Foolish">
  
    <link rel="alternate" href="/atom.xml" title="Contunued Story" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css">

</head>
</html>


  <body>


  
  
  <div class="site-header-image">
    <img id="originBg" width="100%" alt="Hike News" src="">
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
    <img id="blurBg" width="100%" style="top: 96%" alt="Hike News" src="">
  </div>

  <script>
        var imgUrls = "css/images/pose01.jpg,https://source.unsplash.com/collection/954550/1920x1080,https://source.unsplash.com/collection/954550/1920x1081".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("originBg").src=imgUrls[random];
          document.getElementById("blurBg").src=imgUrls[random];
        } else {
          document.getElementById("originBg").src='/' + imgUrls[random];
          document.getElementById("blurBg").src='/' + imgUrls[random];
        }
    </script>




<header id="allheader" class="site-header" role="banner" 
   style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);"  >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="Contunued Story" rel="home"> Contunued Story </a>
            
          </h1>
          
          
            <div class="site-description">Stay Hungry Stay Foolish</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">Categories</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-容器部署"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/19/容器部署/">容器部署</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/19/容器部署/" class="article-date">
	  <time datetime="2019-11-19T05:20:36.000Z" itemprop="datePublished">November 19, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="实现IntelliJ-IDEA快速部署到远程docker"><a href="#实现IntelliJ-IDEA快速部署到远程docker" class="headerlink" title="实现IntelliJ IDEA快速部署到远程docker"></a>实现IntelliJ IDEA快速部署到远程docker</h2><hr>
<ol>
<li><p>IntelliJ IDEA安装Docker插件Docker</p>
</li>
<li><p>增加一个docker远程连接，此时连接的是我虚拟机上的docker<br><img src="/2019/11/19/容器部署/%E8%BF%9C%E7%A8%8Bdocker%E8%BF%9E%E6%8E%A5.png" alt></p>
</li>
<li><p>在项目的根目录下创建Dockerfile文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#指定基础镜像，在其上进行定制</span><br><span class="line">FROM hub.c.163.com/library/java:8-alpine</span><br><span class="line"></span><br><span class="line">#维护者信息</span><br><span class="line">MAINTAINER sunchenming &lt;scm_5@outlook.com&gt;</span><br><span class="line"></span><br><span class="line">#添加target/*.jar 到容器里</span><br><span class="line">ADD target/*.jar app.jar</span><br><span class="line"></span><br><span class="line">#声明运行时容器提供服务端口，这只是一个声明，在运行时并不会因为这个声明应用就会开启这个端口的服务</span><br><span class="line">EXPOSE 8761</span><br><span class="line"></span><br><span class="line">#指定容器启动程序及参数   &lt;ENTRYPOINT&gt; &quot;&lt;CMD&gt;&quot;</span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;app.jar&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>打开IDEA右上角的 Run/Debug Configurations，新增Docker启动方式，然后在配置中填写如下信息</p>
<p> <img src="/2019/11/19/容器部署/%E6%96%B0%E5%A2%9Edocker%E5%90%AF%E5%8A%A8.png" alt></p>
<p> <img src="/2019/11/19/容器部署/%E7%AB%AF%E5%8F%A3%E4%BF%A1%E6%81%AF.png" alt></p>
</li>
<li><p>点击启动，构建成功</p>
<p> <img src="/2019/11/19/容器部署/%E5%90%AF%E5%8A%A8.png" alt></p>
</li>
<li><p>查看docker镜像</p>
<p>  <img src="/2019/11/19/容器部署/%E6%9F%A5%E7%9C%8B.png" alt></p>
</li>
<li><p>将镜像推送到阿里云的镜像个人中心</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker login --username=sunchenming registry.cn-hangzhou.aliyuncs.com</span><br><span class="line">$ sudo docker tag [ImageId] registry.cn-hangzhou.aliyuncs.com/monster_body/springcloud_eureka:[镜像版本号]</span><br><span class="line">$ sudo docker push registry.cn-hangzhou.aliyuncs.com/monster_body/springcloud_eureka:[镜像版本号]</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Ranch"><a href="#Ranch" class="headerlink" title="Ranch"></a>Ranch</h2><hr>
<p>Rancher入门：<a href="https://www.jianshu.com/p/3a492440c89b" target="_blank" rel="noopener">https://www.jianshu.com/p/3a492440c89b</a>  </p>
<p>Rancher是使用一系列的Docker容器进行部署的。运行Rancher跟启动两个容器一样简单。一个容器作为管理服务器部署，另外一个作为集群节点的Agent部署  </p>
<ol>
<li><p>使用docker安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --restart=unless-stopped -p 8080:8080 rancher/server:stable</span><br></pre></td></tr></table></figure>
</li>
<li><p>确认安全组或防火墙允许以下通讯:与其他所有主机之间的 UDP 端口 500 和 4500 (用于IPsec网络)  </p>
</li>
</ol>
<p>防火墙如何开启和关闭？  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start firewalld</span><br><span class="line">sudo systemctl stop firewalld</span><br><span class="line"></span><br><span class="line">firewall-cmd  --permanent --zone=public --add-port=4500/udp 开启</span><br><span class="line">nc -vuz 192.168.1.106 500</span><br><span class="line">firewall-cmd --reload   //更新防火墙规则</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>在Ranch中添加主机，启动一台注册了Rancher-angent的主机</p>
</li>
<li><p>在应用选项-添加应用-springcloud</p>
</li>
<li><p>在springcloud应用下去添加服务</p>
</li>
</ol>
<h2 id="项目版本升级"><a href="#项目版本升级" class="headerlink" title="项目版本升级"></a>项目版本升级</h2>
      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>

      
      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-链路监控"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/18/链路监控/">链路监控</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/18/链路监控/" class="article-date">
	  <time datetime="2019-11-18T12:13:22.000Z" itemprop="datePublished">November 18, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Spring-Cloud-Sleuth"><a href="#Spring-Cloud-Sleuth" class="headerlink" title="Spring Cloud Sleuth"></a>Spring Cloud Sleuth</h2><hr>
<ol>
<li><p>添加sleuth的依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>把 org.springframework.cloud.netflix.feign包 调整日志级别，添加配置</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    org.springframework.cloud.netflix.feign: debug</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>调用order服务的创建订单接口<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO [order,5b8dbc3132a06305,5b8dbc3132a06305,false] 8940 --- [nio-8083-exec-2] c.netflix.config.ChainedDynamicProperty  :</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>sleuth打印的四个值[服务名,id1,id2,true/false]:  </p>
<ul>
<li>id1: trace id,一条链路里面最多包含一条trans id，即一条链路的唯一<br>  标识；</li>
<li>id2: span id，一条链路一面可以包含多个span id，它是一个基本的工作单元（比如发送一个HTTP请求）；</li>
<li>true：将信息输出给其他服务（如zipkin），反之为false</li>
</ul>
<h2 id="Zipkin"><a href="#Zipkin" class="headerlink" title="Zipkin"></a>Zipkin</h2><hr>
<p>链路可视化工具,集成Zinpin的步骤：</p>
<ol>
<li><p>docker 下安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9411:9411 openzipkin/zipkin</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加Zipkin的依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>注：以上依赖包等同于 spring-cloud-starter-sleuth + spring-cloud-sleuth-zipkin的整合，因此原来的spring-cloud-starter-sleuth依赖可直接注释掉</p>
<ol start="3">
<li><p>配置参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zipkin:</span><br><span class="line">  base-url: http://192.168.1.106:9411/</span><br><span class="line">//统计日志的百分比为全部，如果10%填0.1</span><br><span class="line">sleuth:</span><br><span class="line">  sampler:</span><br><span class="line">    percentage: 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用下单接口，访问 Zipkin地址 <a href="http://192.168.1.106:9411" target="_blank" rel="noopener">http://192.168.1.106:9411</a></p>
</li>
</ol>
<p><img src="/2019/11/18/链路监控/%E9%93%BE%E8%B7%AF%E7%9B%91%E6%8E%A7%5Czipkin.png" alt></p>
<h2 id="OpenTracing"><a href="#OpenTracing" class="headerlink" title="OpenTracing"></a>OpenTracing</h2><hr>
<p>OpenTracing是语义规范、是跨语言的，zipkin是根据这个规范的。  </p>
<h3 id="几个重要的概念："><a href="#几个重要的概念：" class="headerlink" title="几个重要的概念："></a>几个重要的概念：</h3><p>traceId：在哪生成的id<br>spanId：下一次的请求id<br>parentId：上一次请求的id</p>
<h3 id="事件类型"><a href="#事件类型" class="headerlink" title="事件类型"></a>事件类型</h3><p>把一个请求的生命周期划成四种事件类型</p>
<ul>
<li>cs(Client Send):客户端发起请求的时间  </li>
<li>cr(Client Received):客户端收到处理完请求的时间  </li>
<li>ss(Server Send):服务端处理完逻辑的时间  </li>
<li>sr(Server Received):服务端收到调用端请求的时间</li>
</ul>
<p><img src="/2019/11/18/链路监控/%E9%93%BE%E8%B7%AF%E7%9B%91%E6%8E%A7%5CZinkin%E6%9E%B6%E6%9E%84.jpg" alt></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Cloud-Sleuth/">Spring Cloud Sleuth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Zipkin/">Zipkin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/链路监控/">链路监控</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-服务容错Hystrix"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/18/服务容错Hystrix/">服务容错Hystrix</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/18/服务容错Hystrix/" class="article-date">
	  <time datetime="2019-11-18T02:55:46.000Z" itemprop="datePublished">November 18, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>防雪崩利器，雪崩就是A调用B，B调用C，C要是不好了，B也不好了</p>
<h2 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h2><hr>
<ul>
<li>优先核心服务，非核心业务不可用或弱可用</li>
<li>通过HystrixCommand注解指定</li>
<li>fallbackMethod（回退函数）中具体实现降级逻辑</li>
</ul>
<p>实现步骤：  </p>
<ol>
<li><p>引入hystrix Jar包依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-hystrix&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类加注解@EnableCircuitBreaker ，或者可直接使用@SpringCloudApplication注解，此注解包含多个注解@SpringBootApplication、@EnableDiscoveryClient、@EnableCircuitBreaker</p>
</li>
<li><p>方法体上增加  @HystrixCommand(fallbackMethod = “fallback”) 注解，fallback是一个方法名，调用其他服务失败或方法内部抛出异常时会运行这个方法<br>类上加@DefaultProperties(defaultFallback = “defaultFallback”) 注解 出现异常可默认调用defaultFallback方法处理  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@DefaultProperties(defaultFallback = &quot;defaultFallback&quot;)</span><br><span class="line">public class HystrixController &#123;</span><br><span class="line">    @HystrixCommand(fallbackMethod = &quot;fallback&quot;)</span><br><span class="line">    @GetMapping(&quot;/getProductInfoList&quot;)</span><br><span class="line">    public String getProductInfoList()&#123;</span><br><span class="line">        RestTemplate restTemplate = new RestTemplate();</span><br><span class="line">        return restTemplate.postForObject(&quot;http://127.0.0.1:8081/product/listForOrder&quot;,</span><br><span class="line">                Arrays.asList(&quot;157875196366160022&quot;),String.class);</span><br><span class="line">    &#125;</span><br><span class="line">    private  String fallback()&#123;</span><br><span class="line">        return &quot;太拥挤了，请稍后再试&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="超时设置"><a href="#超时设置" class="headerlink" title="超时设置"></a>超时设置</h2><hr>
<ol>
<li><p>超时时间设置：方法上增加注解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@HystrixCommand(commandProperties = &#123;</span><br><span class="line">           @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)</span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在yml文件中设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hystrix:</span><br><span class="line">  command:</span><br><span class="line">    default:</span><br><span class="line">      execution:</span><br><span class="line">        isolation:</span><br><span class="line">          thread:</span><br><span class="line">            timeoutInMilliseconds: 2000</span><br><span class="line">    #给getProductInfoList方法单独设置        </span><br><span class="line">    getProductInfoList:</span><br><span class="line">      execution:</span><br><span class="line">        isolation:</span><br><span class="line">          thread:</span><br><span class="line">            timeoutInMilliseconds: 1000</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>有时候第一次启动时都会超时。<br>原因：因为第一次有懒加载的过程，造成了超时。<br>解决方式：配置一下超时时间长一点就好了，如图</p>
<h2 id="熔断"><a href="#熔断" class="headerlink" title="熔断"></a>熔断</h2><hr>
<p>实现进程隔离，容器之间互不影响！  </p>
<ol>
<li>Hystrix依赖隔离：实现的是线程池的隔离，会为每个hystrix command创建独立的线程池，这样就是哪个在hystrix command包装的依赖服务出现延迟较高的情况，也只是对该依赖服务的调用产生影响，并不会拖慢其他服务。</li>
<li>使用了hystrix command把每个函数包装称hystrix  mini时，hystrix框架就会自动为这个函数实现依赖隔离。所以，依赖隔离、服务降级在使用时都是一体化实现的！（一体化？？）</li>
<li>这样，利用hystrix来实现服务容错保护在编程模型上就非常方便了！</li>
</ol>
<h3 id="依赖隔离："><a href="#依赖隔离：" class="headerlink" title="依赖隔离："></a>依赖隔离：</h3><ul>
<li>线程池隔离</li>
<li>Hystrix 自动实现了依赖隔离</li>
</ul>
<h3 id="设置熔断的重要参数"><a href="#设置熔断的重要参数" class="headerlink" title="设置熔断的重要参数"></a>设置熔断的重要参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@HystrixCommand(commandProperties = &#123;</span><br><span class="line">        @HystrixProperty(name=&quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;), // 设置熔断</span><br><span class="line">        @HystrixProperty(name=&quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;10&quot;),//最小请求数</span><br><span class="line">        @HystrixProperty(name=&quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;),//休眠时间窗口</span><br><span class="line">        @HystrixProperty(name=&quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;) //错误百分比 ，比如百分之70，就是10个请求有7个错误</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Circuit Breaker：断路器  ，当故障达到一定值就跳闸  </p>
<p>断路器状态机：</p>
<ol>
<li>closed，熔断器关闭状态，调用失败次数累计到一定阈值/比例，启动熔断机制，进入打开状态</li>
<li>open，熔断器打开状态，对服务直接返回错误，直接服务降级</li>
<li>half open，熔断器打开状态达到了一定的时间，会进入半熔断状态，允许定量的服务请求主逻辑。如果都调用成功，或者一定比例成功，则认为恢复，关闭熔断器；否则，熔断器回到打开状态</li>
</ol>
<p><img src="/2019/11/18/服务容错Hystrix/CircuitBreaker.jpg" alt></p>
<h3 id="添加熔断的可视化组件-hystrix-dashboard"><a href="#添加熔断的可视化组件-hystrix-dashboard" class="headerlink" title="添加熔断的可视化组件 hystrix-dashboard"></a>添加熔断的可视化组件 hystrix-dashboard</h3><ol>
<li><p>引入hystrix-dashboard包依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-hystrix-dashboard&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类添加@EnableHystrixDashboard 注解</p>
</li>
<li><p>访问 <a href="http://localhost:8083/hystrix" target="_blank" rel="noopener">http://localhost:8083/hystrix</a> 添加配置进入<br><img src="/2019/11/18/服务容错Hystrix/Dashboard.png" alt></p>
</li>
</ol>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hystrix/">Hystrix</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/服务容错/">服务容错</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Zuul"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/16/Zuul/">Zuul</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/16/Zuul/" class="article-date">
	  <time datetime="2019-11-16T09:10:26.000Z" itemprop="datePublished">November 16, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="服务网关和Zuul"><a href="#服务网关和Zuul" class="headerlink" title="服务网关和Zuul"></a>服务网关和Zuul</h2><h3 id="常用的网关方案："><a href="#常用的网关方案：" class="headerlink" title="常用的网关方案："></a>常用的网关方案：</h3><ol>
<li>Nginx+Lua</li>
<li>Kong(配置比Nginx简单，很多要付费的插件)</li>
<li>Tyk（各种支持、Go语言开发的）</li>
<li>Spring Cloud Zuul(路由+过滤器，过滤：安全、监控、限流、路由…..)</li>
</ol>
<p>服务网关作为请求入口，不能挂掉。需要保证稳定性、高可用、并发性、安全性、扩展性。<br>网关适合处理非业务功能的绝佳场所：协议转发、日志监控、流量管控、api权限等等。</p>
<h3 id="服务网管的要素"><a href="#服务网管的要素" class="headerlink" title="服务网管的要素"></a>服务网管的要素</h3><ol>
<li>稳定性，高可用</li>
<li>性能、并发性</li>
<li>安全性</li>
<li>扩展性</li>
</ol>
<h3 id="Zuul组件内一次请求的生命周期"><a href="#Zuul组件内一次请求的生命周期" class="headerlink" title="Zuul组件内一次请求的生命周期"></a>Zuul组件内一次请求的生命周期</h3><p><img src="/2019/11/16/Zuul/Zuul%E7%9A%84%E8%AF%B7%E6%B1%82%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.jpg" alt></p>
<h3 id="Zuul组件架构图"><a href="#Zuul组件架构图" class="headerlink" title="Zuul组件架构图"></a>Zuul组件架构图</h3><p><img src="/2019/11/16/Zuul/Zuul%E7%BB%84%E4%BB%B6%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg" alt></p>
<h2 id="Zuul-路由转发，排除和自定义"><a href="#Zuul-路由转发，排除和自定义" class="headerlink" title="Zuul:路由转发，排除和自定义"></a>Zuul:路由转发，排除和自定义</h2><h3 id="如何实现路由转发"><a href="#如何实现路由转发" class="headerlink" title="如何实现路由转发"></a>如何实现路由转发</h3><ol>
<li>新建项目api-getway 选择Cloud Routing -&gt;Zuul、Config Client、Eureka Client</li>
<li>配置config和eureka</li>
<li>Application启动类添加 @EnableZuulProxy注解</li>
<li>直接访问 路由地址/服务名/接口地址 如 localhost:8080/product/product/list (8080为路由的端口)</li>
</ol>
<h3 id="如何自定义和排除"><a href="#如何自定义和排除" class="headerlink" title="如何自定义和排除"></a>如何自定义和排除</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  routes:</span><br><span class="line">  # /myProduct/product/list -&gt; /product/product/list</span><br><span class="line">    myProduct:</span><br><span class="line">      path: /myProduct/**</span><br><span class="line">      serviceId: product</span><br><span class="line">  # 以上简洁写法</span><br><span class="line">    product: /myProduct/**</span><br><span class="line">  # 排除某些路由，可写多个，- 表示空格</span><br><span class="line">  ignored-patterns:</span><br><span class="line">    - /**/product/listForOrder</span><br></pre></td></tr></table></figure>

<h3 id="查看所有路由-localhost-9090-application-routes"><a href="#查看所有路由-localhost-9090-application-routes" class="headerlink" title="查看所有路由 localhost: 9090/application/routes"></a>查看所有路由 localhost: 9090/application/routes</h3><h2 id="Zuul-Cookie和动态路由"><a href="#Zuul-Cookie和动态路由" class="headerlink" title="Zuul:Cookie和动态路由"></a>Zuul:Cookie和动态路由</h2><h3 id="不过滤cookie的办法-sensitiveHeaders不填"><a href="#不过滤cookie的办法-sensitiveHeaders不填" class="headerlink" title="不过滤cookie的办法 sensitiveHeaders不填"></a>不过滤cookie的办法 sensitiveHeaders不填</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">management:</span><br><span class="line">  security:</span><br><span class="line">    enabled: false</span><br><span class="line">zuul:</span><br><span class="line">  ignored-patterns:</span><br><span class="line">  - /**/product/listForOrder</span><br><span class="line">  routes:</span><br><span class="line">    myProduct:</span><br><span class="line">      path: /myProduct/**</span><br><span class="line">      sensitiveHeaders: &apos;&apos;</span><br><span class="line">      serviceId: product</span><br></pre></td></tr></table></figure>

<h4 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h4><ol>
<li>使用spring Cloud Bus实现动态修改路由配置</li>
<li>如何在代码里修改配置不需要更新？<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class ZuuConfig &#123;</span><br><span class="line">    @ConfigurationProperties(&quot;zuul&quot;)</span><br><span class="line">    @RefreshScope</span><br><span class="line">    public ZuulProperties zuulProperties()&#123;</span><br><span class="line">        return new ZuulProperties()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Zuul-高可用"><a href="#Zuul-高可用" class="headerlink" title="Zuul:高可用"></a>Zuul:高可用</h2><ul>
<li>Pre前置过滤器，限流。鉴权，把鉴权逻辑放在Pre。参数过滤，请求转发</li>
<li>Post后置过滤器，统计，日志</li>
<li>多台zuul，需要多台高可用，多个节点都注册到Eureka上面。</li>
<li>可用Nginx和Zuul进行混搭，使用Nginx暴露Url，把请求转发到多个Zuul服务上。Nginx继续做负载均衡</li>
</ul>
<h2 id="Zuul-Pre和Post过滤器"><a href="#Zuul-Pre和Post过滤器" class="headerlink" title="Zuul:Pre和Post过滤器"></a>Zuul:Pre和Post过滤器</h2><p><img src="/2019/11/16/Zuul/Zuul%5C%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg" alt></p>
<ol>
<li><p>Pre过滤器的实现,继承ZuulFilter 实现四个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class TokenFilter extends ZuulFilter&#123;</span><br><span class="line">    @Override</span><br><span class="line">    public String filterType() &#123;</span><br><span class="line">        return PRE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * filterOrder 是过滤器的顺序，越小的优先级越高</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public int filterOrder() &#123;</span><br><span class="line">        return PRE_DECORATION_FILTER_ORDER-1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean shouldFilter() &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 实现逻辑</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public Object run() &#123;</span><br><span class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = requestContext.getRequest();</span><br><span class="line">        //从url参数获取，也可以从cookie,header里获取</span><br><span class="line">        String tocken = request.getParameter(&quot;token&quot;);</span><br><span class="line">        //token为空返回401</span><br><span class="line">        if(StringUtils.isEmpty(tocken))&#123;</span><br><span class="line">            requestContext.setSendZuulResponse(false);</span><br><span class="line">            requestContext.setResponseStatusCode(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Post过滤器的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class AddResponseHeaderFilter  extends ZuulFilter&#123;</span><br><span class="line">    @Override</span><br><span class="line">    public String filterType() &#123;</span><br><span class="line">        return POST_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int filterOrder() &#123;</span><br><span class="line">        return SEND_RESPONSE_FILTER_ORDER-1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean shouldFilter() &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public Object run() &#123;</span><br><span class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletResponse response = requestContext.getResponse();</span><br><span class="line">        //增加一个响应头</span><br><span class="line">        response.setHeader(&quot;X-Foo&quot;, UUID.randomUUID().toString());</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Zuul-限流"><a href="#Zuul-限流" class="headerlink" title="Zuul:限流"></a>Zuul:限流</h2><p>令牌桶式限流<br><img src="/2019/11/16/Zuul/%E4%BB%A4%E7%89%8C%E6%A1%B6%E5%BC%8F%E9%99%90%E6%B5%81.jpg" alt="令牌桶式限流"><br>时机：请求被转发之前调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 限流</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class RateLimitFilter extends ZuulFilter &#123;</span><br><span class="line">    //guava组件对令牌桶的实现</span><br><span class="line">    private static final RateLimiter  RATE_LIMITER =RateLimiter.create(100);</span><br><span class="line">    @Override</span><br><span class="line">    public String filterType() &#123;</span><br><span class="line">        return PRE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int filterOrder() &#123;</span><br><span class="line">        return SERVLET_DETECTION_FILTER_ORDER-1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean shouldFilter() &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object run() &#123;</span><br><span class="line">        //尝试去取一个令牌</span><br><span class="line">        if(!RATE_LIMITER.tryAcquire())&#123;</span><br><span class="line">            throw new RateLimitException();</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>继承ZuulFilter,实现4个方法，修改返回值</li>
<li>filterType()返回值为PRE_TYPE</li>
<li>RateLimiter.create 限制100个</li>
<li>在run方法写限流抛异常</li>
</ol>
<h2 id="Zuul-鉴权"><a href="#Zuul-鉴权" class="headerlink" title="Zuul:鉴权"></a>Zuul:鉴权</h2><p>要实现的业务：  </p>
<ul>
<li>/order/create 只能买家访问</li>
<li>/order/finish 只能卖家访问</li>
<li>/product/list 都可以访问  </li>
</ul>
<ol>
<li><p>/order/create 如何权限校验,先根据访问路径判断是否拦截，再根据买家和卖家各有的特点去判断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 权限拦截（区分买家和卖家）</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class AuthBuyerFilter extends ZuulFilter&#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    @Override</span><br><span class="line">    public String filterType() &#123;</span><br><span class="line">        return PRE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * filterOrder 是过滤器的顺序，越小的优先级越高</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public int filterOrder() &#123;</span><br><span class="line">        return PRE_DECORATION_FILTER_ORDER-1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean shouldFilter() &#123;</span><br><span class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = requestContext.getRequest();</span><br><span class="line">        if(&quot;/order/order/create&quot;.equals(request.getRequestURI()))&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 实现逻辑</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public Object run() &#123;</span><br><span class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = requestContext.getRequest();</span><br><span class="line">        /**</span><br><span class="line">         * /order/create 创建订单只能买家访问</span><br><span class="line">         */</span><br><span class="line">            Cookie cookie = CookieUtil.get(request,&quot;openid&quot;);</span><br><span class="line">            if(cookie == null || StringUtils.isEmpty(cookie.getValue()))&#123;</span><br><span class="line">                requestContext.setSendZuulResponse(false);</span><br><span class="line">                requestContext.setResponseStatusCode(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">            &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>/order/finish 只能卖家访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 权限拦截（区分买家和卖家）</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class AuthSellerFilter extends ZuulFilter&#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    @Override</span><br><span class="line">    public String filterType() &#123;</span><br><span class="line">        return PRE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * filterOrder 是过滤器的顺序，越小的优先级越高</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public int filterOrder() &#123;</span><br><span class="line">        return PRE_DECORATION_FILTER_ORDER-1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean shouldFilter() &#123;</span><br><span class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = requestContext.getRequest();</span><br><span class="line">        if(&quot;/order/order/finish&quot;.equals(request.getRequestURI()))&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 实现逻辑</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public Object run() &#123;</span><br><span class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = requestContext.getRequest();</span><br><span class="line">        /**</span><br><span class="line">         * /order/finish 只能卖家访问</span><br><span class="line">         */</span><br><span class="line">            Cookie cookie = CookieUtil.get(request,&quot;token&quot;);</span><br><span class="line">            if(cookie == null || StringUtils.isEmpty(cookie.getValue())</span><br><span class="line">                    || StringUtils.isEmpty(stringRedisTemplate.opsForValue().get(String.format(RedisConstant.TOKEN_TEMPLATE,cookie.getValue()))) )&#123;</span><br><span class="line">                requestContext.setSendZuulResponse(false);</span><br><span class="line">                requestContext.setResponseStatusCode(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">            &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Zuul-跨域"><a href="#Zuul-跨域" class="headerlink" title="Zuul:跨域"></a>Zuul:跨域</h2><h3 id="什么是跨域问题？"><a href="#什么是跨域问题？" class="headerlink" title="什么是跨域问题？"></a>什么是跨域问题？</h3><blockquote>
<p>同源策略，它是由Netscape提出的一个著名的安全策略。现在所有支持JavaScript 的浏览器都会使用这个策略。所谓同源是指，域名，协议，端口相同。</p>
</blockquote>
<p>同源 域名、协议、端口相同，也就是在同一个域里。</p>
<p>如果非同源，那么在请求数据时，浏览器会在控制台中报一个异常，提示拒绝访问。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><ol>
<li><p>在被调用的类或方法上增加@CrossOrigin注解</p>
</li>
<li><p>在Zuul里增加CorsFilter过滤器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 跨域配置</span><br><span class="line"> * C-Cross O-Origin R-Resource S-Sharing</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class CorsConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public CorsFilter corsFilter()&#123;</span><br><span class="line">        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        final CorsConfiguration config = new CorsConfiguration();</span><br><span class="line">        //是否支持cookie跨域</span><br><span class="line">        config.setAllowCredentials(true);</span><br><span class="line">        //原始域 http:a.com</span><br><span class="line">        config.setAllowedOrigins(Arrays.asList(&quot;*&quot;));</span><br><span class="line">        config.setAllowedHeaders(Arrays.asList(&quot;*&quot;));</span><br><span class="line">        config.setAllowedMethods(Arrays.asList(&quot;*&quot;));</span><br><span class="line">        config.setMaxAge(300l);</span><br><span class="line">        //把跨域的配置注册到source上</span><br><span class="line">        source.registerCorsConfiguration(&quot;*&quot;,config);</span><br><span class="line">        return new CorsFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cookie和动态路由/">Cookie和动态路由</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Zuul/">Zuul</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/服务网关/">服务网关</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/跨域/">跨域</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/鉴权/">鉴权</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/限流/">限流</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-docker的使用"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/13/docker的使用/">Docker的使用</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/13/docker的使用/" class="article-date">
	  <time datetime="2019-11-13T06:20:52.000Z" itemprop="datePublished">November 13, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/开发工具/">开发工具</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="什么是docker"><a href="#什么是docker" class="headerlink" title="什么是docker?"></a>什么是docker?</h4><ul>
<li>从系统环境开始，自底至上打包应用</li>
<li>轻量级，对资源的有效进程隔离和资源管理</li>
<li>使用image，可复用版本化</li>
</ul>
<h4 id="Docker思想"><a href="#Docker思想" class="headerlink" title="Docker思想"></a>Docker思想</h4><ol>
<li>集装箱</li>
<li>标准化：<ul>
<li>运输方式</li>
<li>存储方式</li>
<li>API接口</li>
</ul>
</li>
<li>隔离:类似于虚拟机，更加轻量</li>
</ol>
<h4 id="Docker解决了什么问题："><a href="#Docker解决了什么问题：" class="headerlink" title="Docker解决了什么问题："></a>Docker解决了什么问题：</h4><p>让快速扩展，弹性伸缩变得简单</p>
<h4 id="Docker核心技术"><a href="#Docker核心技术" class="headerlink" title="Docker核心技术"></a>Docker核心技术</h4><ol>
<li>Docker镜像，实质上就是一系列文件（包括应用程序的文件、应用的运行环境的文件），使用了基于分层的联合文件系统实现了镜像存储</li>
<li>Docker容器，本质就是一个进程；可以想象成一个虚拟机，但是是分层的，最上一层可读可写。通过一个镜像可以生成多个容器，独立运行；</li>
<li>Docker仓库，构建镜像在其他服务器上去运行我的程序。先把我的镜像传到仓库，再从其他服务器拉取，类似于起到中转作用</li>
</ol>
<h4 id="Docker-安装"><a href="#Docker-安装" class="headerlink" title="Docker 安装"></a>Docker 安装</h4><ol>
<li><p>保证apt-get是最新版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y docker.io</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看Docker版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="如何创建一个Docker镜像"><a href="#如何创建一个Docker镜像" class="headerlink" title="如何创建一个Docker镜像"></a>如何创建一个Docker镜像</h4><ol>
<li><p>拉取镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull [OPTIONS] NAME[:TAG]</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看本机都有哪些镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images [OPTIONS] [REPOSITORY][:TAG]</span><br></pre></td></tr></table></figure>
</li>
<li><p>后台运行镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run NAME -d</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="Docker运行Nginx"><a href="#Docker运行Nginx" class="headerlink" title="Docker运行Nginx"></a>Docker运行Nginx</h4><ol>
<li><p>去网易云镜像中心下载nginx镜像  <a href="https://c.163yun.com/hub" target="_blank" rel="noopener">https://c.163yun.com/hub</a><br>或者Docker的nginx镜像仓库：<a href="https://hub.docker.com/" target="_blank" rel="noopener">https://hub.docker.com/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull hub.c.163.com/library/nginx:latest</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看正在找运行的容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入容器内部</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec [OPTION] CONTAINER COMMAND [ARG...]</span><br><span class="line">docker exec -it nginx bash</span><br></pre></td></tr></table></figure>
</li>
<li><p>退出容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop 进程名</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="Docker网络"><a href="#Docker网络" class="headerlink" title="Docker网络"></a>Docker网络</h4><h5 id="网络类型"><a href="#网络类型" class="headerlink" title="网络类型"></a>网络类型</h5><ul>
<li>Bridge 桥接模式，独立ip，网络隔离</li>
<li>Host 宿主模式，跟主机一个网络</li>
<li>None</li>
</ul>
<p>把nginx的80端口映射到主机的8080端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8080:80 nginx</span><br></pre></td></tr></table></figure>

<h4 id="制作自己的景象"><a href="#制作自己的景象" class="headerlink" title="制作自己的景象"></a>制作自己的景象</h4><ol>
<li><p>写好Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from hub.c.163.com/library/tomcat</span><br><span class="line"></span><br><span class="line">MAINTAINER sunchenming ***@163.com</span><br><span class="line"></span><br><span class="line">COPY jpress.war /usr/local/tomcat/webapps</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建镜像，docker build</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t jpress:latest</span><br></pre></td></tr></table></figure>

</li>
</ol>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/开发工具/">开发工具</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-统一配置中心"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/13/统一配置中心/">统一配置中心</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/13/统一配置中心/" class="article-date">
	  <time datetime="2019-11-13T06:09:51.000Z" itemprop="datePublished">November 13, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是统一配置中心？"><a href="#什么是统一配置中心？" class="headerlink" title="什么是统一配置中心？"></a>什么是统一配置中心？</h2><ol>
<li>多人改一个配置不方便维护</li>
<li>配置中涉及到内容安全与权限，比如说数据库密码;这里可以把配置文件进行隔离不放进项目代码</li>
<li>重点（更新配置项目需重启）：统一配置中心可实现动态配置，不需重启项目（包括线上配置更新）</li>
</ol>
<h2 id="统一配置中心怎么实现的？"><a href="#统一配置中心怎么实现的？" class="headerlink" title="统一配置中心怎么实现的？"></a>统一配置中心怎么实现的？</h2><p><img src="/2019/11/13/统一配置中心/Config.jpg" alt></p>
<p>一开始把配置放置在远端的git上面。config-server把它拉下来放在本地git，如果远端git出问题了，从本地git把配置拉出来。然后其它服务集成了 Config Client，从Config Server拿到自己的配置</p>
<h2 id="Config的配置"><a href="#Config的配置" class="headerlink" title="Config的配置"></a>Config的配置</h2><h3 id="配置Config-Server端"><a href="#配置Config-Server端" class="headerlink" title="配置Config Server端"></a>配置Config Server端</h3><ol>
<li><p>新建项目 选中Eureka Discovery Client和 Config Server</p>
</li>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(ConfigApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>github上创建config-repo的仓库，在仓库中新增一个 order.yml</p>
</li>
<li><p>在config服务的application.yml增加github的配置信息如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line"><span class="attr">  config:</span></span><br><span class="line"><span class="attr">    server:</span></span><br><span class="line"><span class="attr">      git:</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">https://github.com/ValarMorghulis521/config-repo.git</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">ValarMorghulis521</span></span><br><span class="line"><span class="attr">        password:</span> <span class="string">********</span></span><br><span class="line"><span class="attr">        basedir:</span> <span class="string">github的本地仓库地址</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>本地访问github上的yml配置信息 <a href="http://localhost:8080/release/order-dev.yml" target="_blank" rel="noopener">http://localhost:8080/release/order-dev.yml</a></p>
</li>
</ol>
<h4 id="配置命名的约定规则："><a href="#配置命名的约定规则：" class="headerlink" title="配置命名的约定规则："></a>配置命名的约定规则：</h4><ul>
<li>/{name}-{profiles}.yml   （/文件名-环境名.文件后缀）  </li>
<li>/{label}/{name}-{profiles}.yml  （/分支名/文件名-环境名.文件后缀）</li>
</ul>
<ol>
<li>name 代表服务名  profile 代表 环境名  label 代表分支 branch       </li>
<li>如我要访问dev的配置（默认是master分支）<br><a href="http://localhost:8080/order-dev.yml" target="_blank" rel="noopener">http://localhost:8080/order-dev.yml</a><br>如我要访问dev分支下dev的配置 <a href="http://localhost:8080/dev/order-dev.yml" target="_blank" rel="noopener">http://localhost:8080/dev/order-dev.yml</a>  </li>
</ol>
<h3 id="配置Config-Client端"><a href="#配置Config-Client端" class="headerlink" title="配置Config Client端"></a>配置Config Client端</h3><ol>
<li><p>在需要用到Config Client的服务上新增config-client依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yml文件中新增config的配置,删除数据库其他配置信息</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">order</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        service-id:</span> <span class="string">CONFIG</span></span><br><span class="line"><span class="attr">      profile:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>tips：当我们访问<a href="http://localhost:8080/dev/order-dev.yml" target="_blank" rel="noopener">http://localhost:8080/dev/order-dev.yml</a> 时是如何找到对应的配置？<br> appliction.name+profile.yml对应到github的配置，<strong>所以如果要加载dev后缀的yml order-dev.yml profile一定是dev,因为不小心给写错了导致找不到</strong></p>
<ol start="3">
<li><p><strong>application.yml更名为bootstrap.yml，作为引导先启动</strong>；config-client会先去eureka上找配置的service-id,这里配置的是CONFIG，所以会去找名为“CONFIG”的服务，如果找不到会把127.0.0.01：8888当成config-server ;然后再从configServ上获取 order-dev.yml相关配置信息</p>
</li>
<li><p>只需要创建多个Config Server实例即可实现高可用，不需要相互注册</p>
</li>
<li><p>如果git上有多个配置文件order.yml，order-dev.yml (不管选择哪个环境，order.yml这个是一定会加载访问的，config会把order.yml 和 order-dev.yml里的配置合并，所以可以把公共配置放这order.yml，用不上则注释掉吧)</p>
</li>
</ol>
<h2 id="Spring-Cloud-Bus"><a href="#Spring-Cloud-Bus" class="headerlink" title="Spring Cloud Bus"></a>Spring Cloud Bus</h2><hr>
<p>bus:想上就上的公共汽车。这里是总线的意思</p>
<h3 id="如何实现配置自动刷新"><a href="#如何实现配置自动刷新" class="headerlink" title="如何实现配置自动刷新"></a>如何实现配置自动刷新</h3><ol>
<li>config-server用了Bus之后会提供一个/bus-refresh接口，访问这个接口，config-server便会将更新配置信息发送到消息队列里面（RabbitMQ）</li>
<li>把bus-refresh接口地址配置到git上，通过webhook访问 每次git上配置文件有了变更，便通知config-server</li>
</ol>
<p><img src="/2019/11/13/统一配置中心/Bus.jpg" alt></p>
<h3 id="Spring-Cloud-Bus实操"><a href="#Spring-Cloud-Bus实操" class="headerlink" title="Spring Cloud Bus实操"></a>Spring Cloud Bus实操</h3><ol>
<li><p>修改Spring Cloud 和Spring Boot的版本</p>
</li>
<li><p>添加Spring Cloud Bus的pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置rabbitmq连接地址：<br>为什么没有配置rabbitmq却可以连上  ,没用配置则使用默认</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String host = <span class="string">"localhost"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port = <span class="number">5672</span>;</span><br><span class="line">    <span class="keyword">private</span> String username = <span class="string">"guest"</span>;</span><br><span class="line">    <span class="keyword">private</span> String password = <span class="string">"guest"</span>;</span><br></pre></td></tr></table></figure>

<p>如果你的mq不是搭建在本地，配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  rabbitmq:</span></span><br><span class="line"><span class="attr">    host:</span> </span><br><span class="line"><span class="attr">    port:</span> </span><br><span class="line"><span class="attr">    username:</span> </span><br><span class="line"><span class="attr">    password:</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>feign组件升级为openfeign</p>
</li>
<li><p>配置Bus接口暴露出来：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoins:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      expose:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>在需要刷新配置的类上加 @RefreshScope 注解</p>
<ol start="5">
<li><p>远程git修改之后对bus-refresh发送post请求刷新内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -X POST “http://~~/actuator/bus-refresh”</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置git 的webhook<br>URL:http:***/monitor  (后面不是bus-refresh 而是monitor,因为config这个组件给我提供一个专门用户webhook的路由 monitor)<br>Content type 选择application/json</p>
</li>
</ol>
<p><img src="/2019/11/13/统一配置中心/Webhook%E9%85%8D%E7%BD%AE.png" alt="Webhook配置"></p>
<p>url需要外网地址，使用netapp.cn工具映射外网地址  </p>
<h4 id="使用配置的前缀来映射一个配置类："><a href="#使用配置的前缀来映射一个配置类：" class="headerlink" title="使用配置的前缀来映射一个配置类："></a>使用配置的前缀来映射一个配置类：</h4><ol>
<li><p>配置文件：  </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">girl:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">lili</span></span><br><span class="line"><span class="attr">  age:</span> <span class="number">18</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个对应的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(<span class="string">"girl"</span>)</span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GirlConfig</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Config-Clent/">Config Clent</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Config-Server/">Config Server</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Cloud-Bus/">Spring Cloud Bus</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-消息和异步"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/13/消息和异步/">消息和异步</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/13/消息和异步/" class="article-date">
	  <time datetime="2019-11-13T06:09:24.000Z" itemprop="datePublished">November 13, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="异步和消息"><a href="#异步和消息" class="headerlink" title="异步和消息"></a>异步和消息</h2><blockquote>
<p>异步:客户端请求不会阻塞进程，服务端的响应可以是非即时的</p>
</blockquote>
<hr>
<h3 id="异步的常见形态"><a href="#异步的常见形态" class="headerlink" title="异步的常见形态"></a>异步的常见形态</h3><ul>
<li>通知，一个单项请求</li>
<li>请求/异步响应，客户端发送请求到服务端，服务端异步响应请求，客户端不会阻塞，服务端默认响应不会立刻送达</li>
<li>消息 一对多形态的消息发布，客户端发送消息通知被零个或者多个消费者消费。</li>
</ul>
<h3 id="微服务和容器是天生一对"><a href="#微服务和容器是天生一对" class="headerlink" title="微服务和容器是天生一对"></a>微服务和容器是天生一对</h3><ol>
<li>通过docker的镜像部署超快速实现水平扩展副本克隆</li>
<li>docker的隔离性实现了不同的应用服务打包成不同的</li>
</ol>
<h3 id="MQ应用场景"><a href="#MQ应用场景" class="headerlink" title="MQ应用场景"></a>MQ应用场景</h3><ul>
<li>异步处理：用户注册之后需要发短信，加积分；用户注册成功后通过异步消息让短信服务和积分服务去做他们的事</li>
<li>流量削峰：秒杀活动会因为流量暴增，在应用前端加入消息队列，控制活动的人数，消息队列超过最大长度，直接抛弃请求跳转到错误页面。</li>
<li>日志处理:kafuka 用于日志处理，通过日志采集定时写入kafuka队列，然后kafuka消息队列对日志进行接收储存转发</li>
<li>引用解耦：如用户下单后订单服务通知商品服务</li>
</ul>
<hr>
<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><hr>
<h2 id="RabbitMQ在docker下的安装"><a href="#RabbitMQ在docker下的安装" class="headerlink" title="RabbitMQ在docker下的安装"></a>RabbitMQ在docker下的安装</h2><ol>
<li><p>下载镜像地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull hub.c.163.com/library/rabbitmq:3.7.3-management</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装启动RabbitMQ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --hostname my-rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.7.3-management</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>15672端口是rabbitmq的界面管理地址</p>
<ol start="3">
<li>访问，因为是安装在了虚拟机上，所以本机访问虚拟机的地址 <a href="http://192.168.1.105:15672" target="_blank" rel="noopener">http://192.168.1.105:15672</a> </li>
<li>ok!默认账号密码 guest，成功访问！</li>
</ol>
<h2 id="RabbitMQ的基本使用"><a href="#RabbitMQ的基本使用" class="headerlink" title="RabbitMQ的基本使用"></a>RabbitMQ的基本使用</h2><ol>
<li>添加RabbitMQ的pom.xml的依赖配置</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在yml文件中新增连接RabbitMQ的配置</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  rabbitmq:</span></span><br><span class="line"><span class="attr">    host:</span> </span><br><span class="line"><span class="attr">    port:</span> </span><br><span class="line"><span class="attr">    username:</span> </span><br><span class="line"><span class="attr">    password:</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建一个接收端的类用来接收mq消息</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接收mq消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MqReceiver</span> </span>&#123;</span><br><span class="line"><span class="comment">//  1. @RabbitListener(queues = "myQueue")</span></span><br><span class="line"><span class="comment">//  2. 自动创建队列  @RabbitListener(queuesToDeclare = @Queue("myQueue"))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  3.自动创建，Exchange和Queue绑定  value就是队列</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">        value = <span class="meta">@Queue</span>(<span class="string">"myQueue"</span>),</span><br><span class="line">        exchange =<span class="meta">@Exchange</span>(<span class="string">"myExchange"</span>)</span><br><span class="line">            </span><br><span class="line">    ))</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">"MqReceiver:&#123;&#125;"</span>,message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数码供应商服务接收消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">            exchange =<span class="meta">@Exchange</span>(<span class="string">"myOrder"</span>),</span><br><span class="line">            key = <span class="string">"computer"</span>,</span><br><span class="line">            value = <span class="meta">@Queue</span>(<span class="string">"computerOrder"</span>)</span><br><span class="line">    ))</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processComputer</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">"computer MqReceiver:&#123;&#125;"</span>,message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 水果供应商服务接收消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">            exchange =<span class="meta">@Exchange</span>(<span class="string">"myOrder"</span>),</span><br><span class="line">            key = <span class="string">"fruit"</span>,</span><br><span class="line">            value = <span class="meta">@Queue</span>(<span class="string">"fruitOrder"</span>)</span><br><span class="line">    ))</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processFruit</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">"fruit MqReceiver:&#123;&#125;"</span>,message);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>写一个发送方 用到amqpTemplate.convertAndSend()<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送mq消息测试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MqSenderTest</span> <span class="keyword">extends</span> <span class="title">OrderApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AmqpTemplate amqpTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span></span>&#123;</span><br><span class="line">        amqpTemplate.convertAndSend(<span class="string">"myQueue"</span>,<span class="string">"now"</span>+ <span class="keyword">new</span> Date());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//只会发送给 key=computer的监听</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendOrder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        amqpTemplate.convertAndSend(<span class="string">"myOrder"</span>,<span class="string">"computer"</span>,<span class="string">"now"</span>+ <span class="keyword">new</span> Date());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>创建queue的两种方式 ：</strong>  </p>
<ul>
<li><code>@RabbitListener(queues = &quot;myQueue&quot;)</code> <strong>并在RabbitMQ中手动创建一个myQueue的队列</strong></li>
<li><code>@RabbitListener(queuesToDeclare = @Queue(&quot;myQueue&quot;))</code> <strong>可自动创建</strong></li>
<li><code>key</code>是分组的意思</li>
</ul>
<p><strong>思考：什么情况下直接用queue就行了，什么情况下要和exchange绑定?</strong></p>
<p>设想一个现在虽然是一个点餐系统，如果后期商城规模扩大了，又卖数码又卖水果，订单服务对这两类商品都可以下单。因此现在有订单服务、数码供应服务、水果供应服务、三个服务是独立的，订单，商家都有团队服务。订单要根据不同的商品类型，发送不同MQ消息，数码供应服务只关心数码订单，水果供应服务只关心水果订单，这个时候就涉及到消息的分组；<br>这个时候要涉及到消息的分组,就是route的key就要产生变化了。exchange不用变。<br>然后key就要变了。到了不同的消息队列也就是queue</p>
<p>接收端 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">        exchange =<span class="meta">@Exchange</span>(<span class="string">"myOrder"</span>),</span><br><span class="line">        key = <span class="string">"computer"</span>,</span><br><span class="line">        value = <span class="meta">@Queue</span>(<span class="string">"computerOrder"</span>)</span><br><span class="line">))</span><br></pre></td></tr></table></figure>

<p>发送端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">amqpTemp.converAndSend(<span class="string">"myOrder"</span>,<span class="string">"computer"</span>,<span class="string">"这是要发送的内容"</span>)</span><br></pre></td></tr></table></figure>

<p>第一个参数是 <code>exchange</code>,第二个参数是<code>key</code> <strong>RabbitMQ 中通过 Binding(绑定) 将 Exchange(交换器) 与 Queue(消息队列) 关联起来，在绑定的时候一般会指定一个 BindingKey(绑定键) ,这样 RabbitMQ 就知道如何正确将消息路由到队列了</strong></p>
<h2 id="Spring-Cloud-Stream"><a href="#Spring-Cloud-Stream" class="headerlink" title="Spring Cloud Stream"></a>Spring Cloud Stream</h2><blockquote>
<p>SpringCloud Stream提供更方便的消息处理，达到代码层面对消息中间件的无感知的效果，支持RabbitMQ和ActiveMQ。只需定义Input和Output，无需过多考虑rabbitmq的Exchange和RoutingKey</p>
</blockquote>
<hr>
<p><img src="/2019/11/13/消息和异步/Stream.jpg" alt></p>
<p>应用程序通过inputs 或者 outputs 来与Binder交互，而Stream中的Binder则与中间件交互。Binder是Stream中的一个抽象概念，是应用与消息中间件的粘合剂。<strong>使用Stream最好的好处在于对消息中间件的进一步封装，达到代码层面对消息中间件的无感知的效果，甚至可以动态切换中间件，切换topic</strong></p>
<h3 id="Spring-Cloud-Stream的基本使用"><a href="#Spring-Cloud-Stream的基本使用" class="headerlink" title="Spring Cloud Stream的基本使用"></a>Spring Cloud Stream的基本使用</h3><ol>
<li><p>添加Stream的pom.xml的依赖配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在yml中配置RabbitMQ的连接地址</p>
</li>
<li><p>先定义一个接口  StreamClient ，<code>myMessage</code> 其实就是绑定change(交换器)的名字，当程序启动后会自动创建一个<code>myMessage.anonymousXXXXX</code>的一个队列,绑定了一个 <code>myMessage</code> 的change</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StreamClient</span> </span>&#123;</span><br><span class="line">    String INPUT = <span class="string">"myMessage"</span>;</span><br><span class="line">    <span class="meta">@Input</span>(StreamClient.INPUT)</span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">input</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Output</span>(StreamClient.INPUT)</span><br><span class="line">    <span class="function">MessageChannel <span class="title">output</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>定义一个接收端 需要<code>@EnableBinding</code> 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableBinding</span>(StreamClient.class)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamReceiver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@StreamListener</span>(StreamClient.INPUT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Object message)</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">"StreamReceiver:&#123;&#125;"</span>,message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义一个发送端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMessageController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StreamClient streamClient;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/sendMessage"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String message = <span class="string">"now"</span>+ <span class="keyword">new</span> Date();</span><br><span class="line">    streamClient.output().send(MessageBuilder.withPayload(message).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置分组：一个实例发送消息只让一个实例收到消息<br>group 表示分组；content-type表示传送的格式</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stream:</span></span><br><span class="line"><span class="attr">  bindings:</span></span><br><span class="line"><span class="attr">    myMessage:</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">order</span></span><br><span class="line"><span class="attr">      content-type:</span> <span class="string">application/json</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>如何实现在MQ这个地方让他显示是json字符串？</strong>   </p>
<p>只需要增加 <code>content-type: application/json</code> 配置即可</p>
<p><strong>如何在收到消息后回发消息？</strong>  </p>
<p>增加 @ReturnTo 注解 <code>@SendTo(StreamClient.INPUT2)</code> 表示把消息回发给谁<br>接收方需要增加INPUT2的消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@StreamListener</span>(StreamClient.INPUT)</span><br><span class="line"><span class="meta">@SendTo</span>(StreamClient.INPUT2)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">process</span><span class="params">(Object message)</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">"StreamReceiver:&#123;&#125;"</span>,message);</span><br><span class="line">    <span class="comment">//使用SendTo 注解 回发mq消息给input2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"received."</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里用来接收INPUT向INPUT2回发的消息</span></span><br><span class="line"><span class="meta">@StreamListener</span>(StreamClient.INPUT2)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process2</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">"StreamReceiver2:&#123;&#125;"</span>,message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="商品和订单服务中使用MQ"><a href="#商品和订单服务中使用MQ" class="headerlink" title="商品和订单服务中使用MQ"></a>商品和订单服务中使用MQ</h2><h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p><img src="/2019/11/13/消息和异步/%E5%95%86%E5%93%81%E5%92%8C%E8%AE%A2%E5%8D%95%E4%BD%BF%E7%94%A8MQ.png" alt></p>
<ol>
<li><p>商品服务接入配置中心添加依赖，注册到配置中心</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>商品服务需要在扣库存的地方发送一个消息，在yml文件中新增连接RabbitMQ的配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  rabbitmq:</span></span><br><span class="line"><span class="attr">    host:</span> </span><br><span class="line"><span class="attr">    port:</span> </span><br><span class="line"><span class="attr">    username:</span> </span><br><span class="line"><span class="attr">    password:</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装redis和RedisDesktopManager ，引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>启动redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 6379:6379 redis:4.0.8</span><br></pre></td></tr></table></figure>

<p>在订单服务中配置redis的信息</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">redis:</span></span><br><span class="line"><span class="attr">   host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span></span><br><span class="line"><span class="attr">   port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>在order服务中message包下新建ProductInfoReceiver 从mq中接受商品信息，把商品id和库存 放入redis中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductInfoReceiver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PRODUCT_STOCK_TEMPLATE = <span class="string">"product_stock_%s"</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queuesToDeclare = <span class="meta">@Queue</span>(<span class="string">"productInfo"</span>))</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        <span class="comment">//message =&gt; ProductInfoOutput</span></span><br><span class="line">        <span class="comment">//ProductInfoOutput productInfoOutput = (ProductInfoOutput)JsonUtil.fromJson(message, ProductInfoOutput.class);</span></span><br><span class="line">        List&lt;ProductInfoOutput&gt; productInfoOutputList = ( List&lt;ProductInfoOutput&gt;)JsonUtil.fromJson(message,</span><br><span class="line">                <span class="keyword">new</span> TypeReference&lt; List&lt;ProductInfoOutput&gt;&gt;()&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"从&#123;&#125;接受到消息:&#123;&#125;"</span>,<span class="string">"productInfo"</span>,productInfoOutputList);</span><br><span class="line">        <span class="keyword">for</span>(ProductInfoOutput productInfoOutput : productInfoOutputList)&#123;</span><br><span class="line">            <span class="comment">//储存到redis中</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(String.format(PRODUCT_STOCK_TEMPLATE,productInfoOutput.getProductId()),</span><br><span class="line">                    String.valueOf(productInfoOutput.getProductStock()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在product服务中改造减库存的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decreaseStock</span><span class="params">(List&lt;DecreaseStockInput&gt; decreaseStockInputList)</span> </span>&#123;</span><br><span class="line">       List&lt;ProductInfo&gt; productInfoList = decreaseStockProcess(decreaseStockInputList);</span><br><span class="line">       <span class="comment">//扣完库存发送mq消息</span></span><br><span class="line">       List&lt;ProductInfoOutput&gt; productInfoOutputList = productInfoList.stream().map(e -&gt;&#123;</span><br><span class="line">           ProductInfoOutput output = <span class="keyword">new</span> ProductInfoOutput();</span><br><span class="line">           BeanUtils.copyProperties(e,output);</span><br><span class="line">           <span class="keyword">return</span> output;</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line">       amqpTemplate.convertAndSend(<span class="string">"productInfo"</span>, JsonUtil.toJson(productInfoOutputList));</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Transactional</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;ProductInfo&gt; <span class="title">decreaseStockProcess</span><span class="params">(List&lt;DecreaseStockInput&gt; decreaseStockInputList)</span> </span>&#123;</span><br><span class="line">       List&lt;ProductInfo&gt; productInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">       <span class="keyword">for</span> (DecreaseStockInput decreaseStockInput : decreaseStockInputList) &#123;</span><br><span class="line">           Optional&lt;ProductInfo&gt; productInfoOptional = productInfoRepository.findById(decreaseStockInput.getProductId());</span><br><span class="line">           <span class="comment">//判断商品是否存在</span></span><br><span class="line">           <span class="keyword">if</span> (!productInfoOptional.isPresent()) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> ProductException(ResultEnum.PRODUCT_NOT_EXIST);</span><br><span class="line">           &#125;</span><br><span class="line">           ProductInfo productInfo = productInfoOptional.get();</span><br><span class="line">           <span class="comment">//库存是否足够</span></span><br><span class="line">           Integer result = productInfo.getProductStock() - decreaseStockInput.getProductQuantity();</span><br><span class="line">           <span class="keyword">if</span> (result &lt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> ProductException(ResultEnum.PRODUCT_STOCK_ERROR);</span><br><span class="line">           &#125;</span><br><span class="line">           productInfo.setProductStock(result);</span><br><span class="line">           productInfoRepository.save(productInfo);</span><br><span class="line">           productInfoList.add(productInfo);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> productInfoList;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="异步扣库存分析"><a href="#异步扣库存分析" class="headerlink" title="异步扣库存分析"></a>异步扣库存分析</h2><hr>
<h3 id="原始流程"><a href="#原始流程" class="headerlink" title="原始流程"></a>原始流程</h3><ol>
<li>查询商品信息（调用商品服务）</li>
<li>计算总价（生成订单详情）</li>
<li>商品服务扣库存（调用商品服务）</li>
<li>订单入库（生成订单）</li>
</ol>
<h3 id="改造成基于消息队列的异步事件驱动"><a href="#改造成基于消息队列的异步事件驱动" class="headerlink" title="改造成基于消息队列的异步事件驱动"></a>改造成基于消息队列的异步事件驱动</h3><h4 id="如果把订单入库这一步改造成异步的"><a href="#如果把订单入库这一步改造成异步的" class="headerlink" title="如果把订单入库这一步改造成异步的"></a>如果把订单入库这一步改造成异步的</h4><p>通过消息队列异步创建订单；如果第四步异步下单创失败了，解决办法 可以尝试重试生成订单，不处理成功mq的消息就一直存在</p>
<h4 id="异步扣库存分析-1"><a href="#异步扣库存分析-1" class="headerlink" title="异步扣库存分析"></a>异步扣库存分析</h4><p> 如果商品服务扣库存也变成异步。如果订单服务生成订单成功，而商品扣库存失败又该如何回滚？</p>
<h5 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h5><ul>
<li>订单创建成功后，订单的状态是排队中，发布一个order_create事件到mq上，由mq负责转发给订阅该消息的服务，如果商品服务收到创建订单消息后执行扣库存操作。</li>
<li>这里扣库存由于某些原因可能扣失败，商品服务会发送一个扣库存的消息给队列，消息里面的内容是扣库存的结果。订单服务来订阅扣库存的结果，接收到该消息后，如果扣库存成功将订单的状态改为已确认即下单成功，如果扣库存失败则把订单取消<ul>
<li>以上需要可靠的消息投递。订单服务检测商品服务扣失败的情况，然后进行补偿</li>
<li>在这种情况下，用户体验的变化。用户是不能立刻马上知道下单的结果。像12306买票会得到排队中的结果。可以承受住很大的并发请求。适合秒杀类的业务场景</li>
</ul>
</li>
</ul>
<h5 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h5><ul>
<li>也可以订单创建后直接返回结果，发送创建订单的消息，让商品服务与订单服务订阅该消息并异步执行自己的操作，而创建订单写入数据库采用异步实现。但前提是若商品服务扣库存或订单服务下订单有一方操作失败要回滚，则异步写入数据库要实现相应错误处理或补偿机制】</li>
</ul>
<h4 id="异步扣库存分析汇总"><a href="#异步扣库存分析汇总" class="headerlink" title="异步扣库存分析汇总"></a>异步扣库存分析汇总</h4><ol>
<li>订单服务实现复制一份库存副本，保存到Redis中</li>
<li>收到请求，Redis判断是否库存充足，减掉Redis中库存</li>
<li>订单服务创建订单写入数据库，并发送消息</li>
</ol>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RabbitMQ/">RabbitMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Cliud-Stream/">Spring Cliud Stream</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-应用通信"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/11/应用通信/">应用通信</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/11/应用通信/" class="article-date">
	  <time datetime="2019-11-11T14:50:42.000Z" itemprop="datePublished">November 11, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HTTP-VS-RPC"><a href="#HTTP-VS-RPC" class="headerlink" title="HTTP VS RPC"></a>HTTP VS RPC</h2><ul>
<li><p>Dubbo是一个RPC框架，服务治理集成非常完善，不仅提供了服务注册发现，负载均衡，路由等面向分布式集群，面向开发测试，服务治理和监控的可视化平台。</p>
</li>
<li><p>Spring Cloud，微服务架构下的一站式解决方案，HttpRestful:本身轻量易用，适用性强，可以很容易跨语言跨平台，或者与已有的系统交互。微服务之间使用Http Restful调用方式：<strong>RestTemplate 、Feign</strong>; </p>
</li>
</ul>
<h2 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h2><h3 id="order服务访问product的三种方式，本质上都是使用RestTemplate"><a href="#order服务访问product的三种方式，本质上都是使用RestTemplate" class="headerlink" title="order服务访问product的三种方式，本质上都是使用RestTemplate"></a>order服务访问product的三种方式，本质上都是使用RestTemplate</h3><p>order服务的调用代码块</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/getProductMsg"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProductMsg</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.第一种方式 ,直接使用restTemplate，url写死</span></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        String response =  restTemplate.getForObject(<span class="string">"http://localhost:8080/msg"</span>,String.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.第二种方式 利用loadBalancerClient通过应用名获取url，然后再使用restTemplate</span></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="string">"PRODUCT"</span>);</span><br><span class="line">        String url = String.format(<span class="string">"http://%s:%s"</span>,serviceInstance.getHost(),serviceInstance.getPort()+<span class="string">"/msg"</span>);</span><br><span class="line">        String response = restTemplate.getForObject(url,String.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.第三种方式,利用 LoadBalanced，可在restTemplate里使用应用名字</span></span><br><span class="line">        String response = restTemplate.getForObject(<span class="string">"http://PRODUCT/msg"</span>,String.class);</span><br><span class="line">        log.info(<span class="string">"response=&#123;&#125;"</span>,response);</span><br><span class="line">        <span class="keyword">return</span>  response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三种方式还需要加个配置类把RestTemplate作为一个bean配置上去，<strong>其中@LoadBlanced注解其实是Ribbon的组件。会帮你用轮询或者随机连接等实现负载均衡。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="负载均衡器：Ribbon"><a href="#负载均衡器：Ribbon" class="headerlink" title="负载均衡器：Ribbon"></a>负载均衡器：Ribbon</h2><hr>
<p>Eureka中是客户端这边做负载均衡的，而不是服务端</p>
<p><strong>Ribbon实现软负载均衡核心有三点</strong>  </p>
<ol>
<li>服务发现:发现依赖服务的列表(依据服务的名字，把所有实例都找出来)</li>
<li>服务选择规则:依据规则策略如何从多个服务中选择一个有效的服务</li>
<li>服务监听: 检测失效的服务，做到高效剔除</li>
</ol>
<h3 id="客服端负载均衡器：Ribbon"><a href="#客服端负载均衡器：Ribbon" class="headerlink" title="客服端负载均衡器：Ribbon"></a>客服端负载均衡器：Ribbon</h3><ol>
<li>RestTemplate、Feign、Zuul都使用到了Ribbon</li>
<li>主要组件ServerList，IRule,ServerListFilter</li>
<li>主要流程：首先通过ServerList获取所有可用服务列表，然后通过ServerListFilter过滤掉一部分地址，通过IRule选择一个实例作为最终目标结果；</li>
</ol>
<h3 id="追踪源码自定义负载均衡策略"><a href="#追踪源码自定义负载均衡策略" class="headerlink" title="追踪源码自定义负载均衡策略"></a>追踪源码自定义负载均衡策略</h3><p>默认使用轮询  </p>
<h3 id="如何改变负载均衡策略？"><a href="#如何改变负载均衡策略？" class="headerlink" title="如何改变负载均衡策略？"></a>如何改变负载均衡策略？</h3><p>application.yml. </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="attr">  ribbon:</span></span><br><span class="line"><span class="attr">    NIWSServerListClassName:</span> <span class="string">com.netflix.loadbalancer.ConfigurationBasedServerList</span></span><br><span class="line"><span class="attr">    NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.WeightedResponseTimeRule</span></span><br></pre></td></tr></table></figure>

<h2 id="Feign的使用"><a href="#Feign的使用" class="headerlink" title="Feign的使用"></a>Feign的使用</h2><ul>
<li>声明式REST客户端（伪RPC），Feign本质上是一个远程方法，http客户端发送http请求;通过Feign我们能把Http请求对开发者完全透明，得到与调用本地方法一致的编码体验</li>
<li>采用了基于接口的注解 </li>
<li>内部使用的Ribbon做负载均衡</li>
</ul>
<h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><ol>
<li><p>添加feign的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.M3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在启动主类上添加@EnableFeignClients注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个Feign的客户端 接口声明你要调用哪个服务的哪些方法 ，@FeignClient表示你要调用服务的名称，@GetMapping(“/msg”)表示你要调用这个服务下的哪个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用product服务的msg</span></span><br><span class="line"><span class="meta">@FeignClient</span>(name=<span class="string">"product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/product/msg"</span>)</span><br><span class="line">    <span class="function">String <span class="title">productMsg</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>把上上声明的接口注入到controller，直接调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductClient productClient;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProductMsg</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String response = productClient.productMsg();</span><br><span class="line">        log.info(<span class="string">"response=&#123;&#125;"</span>,response);</span><br><span class="line">        <span class="keyword">return</span>  response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="业务流程中注意要点"><a href="#业务流程中注意要点" class="headerlink" title="业务流程中注意要点"></a>业务流程中注意要点</h3><ol>
<li><p><strong>controller方法中如果请求带参数必须使用 @RequestBody 结合@PostMapping</strong></p>
</li>
<li><p>使用谷歌的Gson工具把json字符串转为list<object><br>加入依赖</object></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用谷歌的Gson工具</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    orderDetailList = gson.fromJson(</span><br><span class="line">        orderForm.getItems(),<span class="keyword">new</span> TypeToken&lt;List&lt;OrderDetail&gt;&gt;()&#123;&#125;.getType());</span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">    log.error(<span class="string">"【json转换】错误,string=&#123;&#125;"</span>,orderForm.getItems());</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> OrderException(ResultEnum.PARAM_ERROR);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="整合接口打通下单流程"><a href="#整合接口打通下单流程" class="headerlink" title="整合接口打通下单流程"></a>整合接口打通下单流程</h2><ol>
<li>查询商品信息（调用商品服务）</li>
<li>计算总价 (遍历购物车的商品，单价*数量，累加 )</li>
<li>扣库存（调用商品服务）</li>
<li>订单入库</li>
</ol>
<p>核心业务代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> OrderDTO <span class="title">cteate</span><span class="params">(OrderDTO orderDTO)</span> </span>&#123;</span><br><span class="line">        String orderId = KeyUtil.getUniqueKey();</span><br><span class="line">        <span class="comment">// 查询商品信息（调用商品服务）</span></span><br><span class="line">        List&lt;String&gt; productIdList = orderDTO.getOrderDetailList().stream()</span><br><span class="line">                .map(OrderDetail::getProductId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        List&lt;ProductInfo&gt; productInfoList = productClient.listForOrder(productIdList);</span><br><span class="line">        <span class="comment">// 计算总价</span></span><br><span class="line">        BigDecimal orderAmount = <span class="keyword">new</span> BigDecimal(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span>(OrderDetail orderDetail :orderDTO.getOrderDetailList())&#123;</span><br><span class="line">            <span class="keyword">for</span>(ProductInfo productInfo : productInfoList)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(orderDetail.getProductId().equals(productInfo.getProductId()))&#123;</span><br><span class="line">                        <span class="comment">//单价*数量</span></span><br><span class="line">                        orderAmount = productInfo.getProductPrice()</span><br><span class="line">                                .multiply(<span class="keyword">new</span> BigDecimal(orderDetail.getProductQuantity()))</span><br><span class="line">                                .add(orderAmount);</span><br><span class="line">                        BeanUtils.copyProperties(productInfo,orderDetail);</span><br><span class="line">                        orderDetail.setOrderId(orderId);</span><br><span class="line">                        orderDetail.setDetailId(KeyUtil.getUniqueKey());</span><br><span class="line">                        <span class="comment">//订单详情入库</span></span><br><span class="line">                        orderDetailRepository.save(orderDetail);</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;CardDTO&gt;cardDTOList = orderDTO.getOrderDetailList().stream()</span><br><span class="line">                .map(e -&gt; <span class="keyword">new</span> CardDTO(e.getProductId(),e.getProductQuantity()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="comment">//TODO 扣库存（调用商品服务）</span></span><br><span class="line">        productClient.decreaseStock(cardDTOList);</span><br><span class="line">        <span class="comment">//订单入库</span></span><br><span class="line">        OrderMaster orderMaster = <span class="keyword">new</span> OrderMaster();</span><br><span class="line">        orderDTO.setOrderId(KeyUtil.getUniqueKey());</span><br><span class="line">        BeanUtils.copyProperties(orderDTO,orderMaster);</span><br><span class="line">        orderMaster.setOrderAmount(orderAmount);</span><br><span class="line">        orderMaster.setOrderStatus(OrderStatusEnum.NEW.getCode());</span><br><span class="line">        orderMaster.setPayStatus(PayStatusEnum.WAIT.getCode());</span><br><span class="line"></span><br><span class="line">        orderMasterRepository.save(orderMaster);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>BigDecimal 类型的值可使用multiply、add 进行相乘相加</p>
<h2 id="项目改成多模块"><a href="#项目改成多模块" class="headerlink" title="项目改成多模块"></a>项目改成多模块</h2><h3 id="存在问题"><a href="#存在问题" class="headerlink" title="存在问题"></a>存在问题</h3><ol>
<li>Product服务像商品服务提供的商品信息查询接口，返回的是ProductInfo实体， 不能把自己数据表对应的实体类给暴露出去</li>
<li>商品服务和订单服务都定义了ProductInfo 同一个对象在多处定义</li>
<li>在订单服务中声明了一个FeignCilen客户端，定义了一些接口表明要调用商品服务下的哪些方法，在订单服务写商品服务的url显然是不合适的，自己定义自己的接口暴露给外部调用</li>
</ol>
<p>如何解决上面上个问题？</p>
<h3 id="把原项目划分为三个模块"><a href="#把原项目划分为三个模块" class="headerlink" title="把原项目划分为三个模块"></a>把原项目划分为三个模块</h3><ul>
<li>product-server :所有的业务逻辑，Controller,Service</li>
<li>product-client ：对外暴露的接口,商品模块对外暴露了两个接口获取商品列表、扣库存</li>
<li>product-common :公用的对象，既会被外部服务调用，也会被内部其他模块使用</li>
</ul>
<p>这三个模块之间是什么依赖关系？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">product-server -&gt;&gt; product-common:调用</span><br><span class="line">product-client -&gt;&gt; product-common:调用</span><br></pre></td></tr></table></figure>

<h3 id="如何打包商品服务的jar包给订单服务调用？"><a href="#如何打包商品服务的jar包给订单服务调用？" class="headerlink" title="如何打包商品服务的jar包给订单服务调用？"></a>如何打包商品服务的jar包给订单服务调用？</h3><p>mvn -Dmaven.test.skip=true -U clean install (将jar包清理且安装到本地)</p>
<p>如何启动且调用？  </p>
<ol>
<li>启动商品服务</li>
<li>启动订单服务<br>postman访问接口即可。</li>
</ol>
<h3 id="同步or异步"><a href="#同步or异步" class="headerlink" title="同步or异步"></a>同步or异步</h3><p>在多模块中订单服务和商品服务之间的通讯机制目前是同步，订单会调用商品服务的查询商品信息、扣库存的接口；</p>
<p>微服务中除了同步，有很多时候会在异步的场景下：<strong>通过队列和订阅主题实现消息的发布和订阅</strong>；一个微服务可以是消息的发布者，把消息通过异步的方式发送到队列或者订阅主题下。作为消费者的微服务可以从队列或者主题中获取消息，通过消息中间件把服务之间的直接调用解耦，</p>
<p><strong>哪个场景下需要使用异步？</strong>  </p>
<p>比如用户服务在用户登录的时候 要给用户发短信 -&gt;调用短信服务 ,加积分-&gt;积分服务…如果都采用同步的通讯机制，服务间耦合过大，用户登录成功需要向多个服务同步响应后才能成功，会造成不好的用户体验。这个时候我们可以通过消息队列就能够很好的解决这个问题</p>
<p>再比如订单服务和商品服务，订单服务在扣库存前会先调用商品服务的查询商品信息的接口，再调用扣库存的接口。<br>如果我们对其改造：商品服务在更改库存的时候发布库存变化的消息，订单服务来订阅这个消息可以获取到商品的部分信息：可购买的商品个数，商品ID .在下单的时候订单服务不需要再同步的查询商品服务获取商品的库存信息，而是直接查询自己服务中的数据。 再扣库存的时候订单服务发布一个扣库存的消息，商品服务要订阅这个消息，拿到消息后减库存。</p>
<p><img src="/2019/11/11/应用通信/%E5%BA%94%E7%94%A8%E9%80%9A%E4%BF%A1%5C%E6%B6%88%E6%81%AF%E5%BC%82%E6%AD%A5.jpg" alt></p>
<p>如果订单支付成功或失败会有什么影响？比如可以设置30分钟后未支付，由支付服务发布消息，商品和订单服务同时订阅这个消息 来保证数据的最终一致性。 这样有什么好处？ 如果用户购买成功后还需要加积分，发短信，这个时候订单服务就不需要修改了，短信服务和积分服务只要也订阅了对应的消息就可以搞定。</p>
<p><strong>通过消息中间件，解耦,服务间的交互变得更加灵活，如果都使用同步服务，开销太大， 可以通过消息队列解决同步的问题，使之变成异步</strong></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/微服务实战/">微服务实战</a>

      
      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Java的IO机制"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/10/Java的IO机制/">Java的IO机制</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/10/Java的IO机制/" class="article-date">
	  <time datetime="2019-11-10T14:29:14.000Z" itemprop="datePublished">November 10, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/Java常用类库与技巧/">Java常用类库与技巧</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Java文件模型：在硬盘上的文件是 byte数据的集合</p>
<p>可以分为IO流（输入流、输出流）<br>也可以分为字节流、字符流</p>
<h3 id="字节流"><a href="#字节流" class="headerlink" title="字节流"></a>字节流</h3><p>InputStream、OutputStream 是字节流输入输出的抽象类，<br>InputStream抽象了应用程序读取数据的方式，OutputStream抽象了应用程序写出数据的方式</p>
<p>EOF = END 代表读到-1就结束</p>
<h4 id="输入流的基本方法"><a href="#输入流的基本方法" class="headerlink" title="输入流的基本方法"></a>输入流的基本方法</h4><ol>
<li><p><code>int b = in.read();</code> 读取一个字节无符号填充到int 低八位、-1是EOF</p>
</li>
<li><p><code>in.read(byte[]buf)</code> 读取数据填充到字节数组 buf</p>
</li>
<li><p><code>in.read(byte[] buf,int start,int size)</code> 读取数据到字节数组buf,从buf的start位置开始存放size长度的数据</p>
</li>
<li><p>FileInputStream 实现了在文件上读取数据</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取指定文件内容，按照16进制输出到控制台</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printHex</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        FileInputStream in = <span class="keyword">new</span> FileInputStream(fileName);</span><br><span class="line">        <span class="keyword">int</span> b;</span><br><span class="line">        <span class="keyword">while</span>((b = in.read()) !=-<span class="number">1</span>)&#123;</span><br><span class="line">            System.out.print(Integer.toHexString(b)+ <span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        in.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printHexByByteArray</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        FileInputStream in = <span class="keyword">new</span> FileInputStream(fileName);</span><br><span class="line">        <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">20</span>*<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 从 in中批量读取字节，放入到buf这个字节数组中，</span></span><br><span class="line"><span class="comment">         * 从第0个位置开始放，最多放buf.length个</span></span><br><span class="line"><span class="comment">         * 返回的是读到的字节的个数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//        int bytes = in.read(buf,0,buf.length);</span></span><br><span class="line"><span class="comment">//        int j =1;</span></span><br><span class="line"><span class="comment">//        for(int i =0;i&lt;bytes;i++)&#123;</span></span><br><span class="line"><span class="comment">//            if(buf[i] &lt;= 0xf)&#123;</span></span><br><span class="line"><span class="comment">//                System.out.print("0");</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            System.out.print(Integer.toHexString(buf[i]&amp; 0xff)  +" ");</span></span><br><span class="line"><span class="comment">//            if(j++ %10==0)&#123;</span></span><br><span class="line"><span class="comment">//                System.out.println();</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="comment">//当字节数组不够大，一次性读不完文件时怎么办？</span></span><br><span class="line">        <span class="keyword">int</span> bytes = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((bytes = in.read(buf,<span class="number">0</span>,buf.length))!=-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span> ;i&lt;bytes;i++)&#123;</span><br><span class="line">                <span class="comment">//byte类型8位，int类型32位,为了避免转换错误，通过 &amp;0xff将高24位清零</span></span><br><span class="line">                System.out.print(Integer.toHexString(buf[i] &amp; <span class="number">0xff</span>)+<span class="string">" "</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>DataInputStream/DataOutputStream 对“流”功能的扩展，可以更加方便的读取int,long 字符等类型<br>DataOutputStream: writeInt()/writeDouble/writeUTF()</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testDataInputStrem</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        String file = <span class="string">"d:\\out.dat"</span>;</span><br><span class="line">        DataInputStream dis = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">        <span class="keyword">int</span> i =dis.readInt();</span><br><span class="line">        System.out.println(i);</span><br><span class="line">        <span class="keyword">long</span> l = dis.readLong();</span><br><span class="line">        System.out.println(l);</span><br><span class="line">        String s = dis.readUTF();</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        dis.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testDataOutputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String file = <span class="string">"d:\\out.dat"</span>;</span><br><span class="line">        DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        dos.writeInt(<span class="number">10</span>);</span><br><span class="line">        dos.writeLong(<span class="number">10</span>);</span><br><span class="line">        dos.writeUTF(<span class="string">"中国"</span>);</span><br><span class="line">        dos.close();</span><br><span class="line">        IOUtil.printHex(file);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>字节缓冲流:BufferedInputStresm 、BufferedOutputStream<br>这两个流类为IO提供了带缓冲区的操作，一般打开文件进行写入或读取时都会加上缓冲，这种流模式提高了IO性能  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFileByBuffer</span><span class="params">(File srcFile, File destFile)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(!srcFile.exists())&#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"文件"</span>+srcFile+<span class="string">"不存在"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(!srcFile.isFile())&#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"文件"</span>+srcFile+<span class="string">"不是存在"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       BufferedInputStream bif = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(srcFile));</span><br><span class="line">       BufferedOutputStream bos = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(destFile));</span><br><span class="line">       <span class="keyword">int</span> b;</span><br><span class="line">       <span class="keyword">while</span> ((b=bif.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">           bos.write(b);</span><br><span class="line">       &#125;</span><br><span class="line">       bos.flush();</span><br><span class="line">       bif.close();</span><br><span class="line">       bos.close();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>从应用程序中把输入放进文件，相当于将一桶水倒进到另一个缸中：<br>FileOutputStream -&gt;write()方法相当于一滴一滴地把水“转移过去”<br>DataoutputStream -&gt;writeXX()方法相当于一瓢一瓢把水“转移过去”<br>BufferedInputStresm -&gt;write()方法相当于一瓢一瓢先放入桶中，再从桶中倒入到缸里</p>
<h4 id="输出流基本方法"><a href="#输出流基本方法" class="headerlink" title="输出流基本方法"></a>输出流基本方法</h4><ol>
<li><code>out.write(int b);</code> 写出一个byte到流，b的低8位</li>
<li><code>out.write(byte[]buuf)</code> 将buf字符数组都写入到流</li>
<li><code>out.write(byte[] buf,int start,int size)</code> 字节数组buf,从buf的start位置开始写size长度的字节到流</li>
<li>FileOutputStream 实现了向文件中写出byte数据的方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果该文件不存在，则直接创建，如果存在，删除后创建</span></span><br><span class="line">FileOutputStream out = <span class="keyword">new</span> FileOutputStream(<span class="string">"d:\\out.dat"</span>);</span><br><span class="line">out.write(<span class="string">'A'</span>); <span class="comment">//写出 A的低八位</span></span><br><span class="line">out.write(<span class="string">'B'</span>); <span class="comment">//写出 B的低八位</span></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">10</span>;<span class="comment">//write只能写八位，那么写一个int需要写四次</span></span><br><span class="line">out.write(a &gt;&gt;&gt; <span class="number">24</span>);</span><br><span class="line">out.write(a &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">out.write(a &gt;&gt;&gt; <span class="number">8</span>);</span><br><span class="line">out.write(a );</span><br><span class="line"><span class="keyword">byte</span>[]gbk = <span class="string">"中国"</span>.getBytes(<span class="string">"gbk"</span>);</span><br><span class="line">out.write(gbk);</span><br><span class="line">out.close();</span><br></pre></td></tr></table></figure>

<p>实现一个文件复制功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(File srcFile, File destFile)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!srcFile.exists())&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"文件"</span>+srcFile+<span class="string">"不存在"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!srcFile.isFile())&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"文件"</span>+srcFile+<span class="string">"不是存在"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    FileInputStream in = <span class="keyword">new</span> FileInputStream(srcFile);</span><br><span class="line">    FileOutputStream out = <span class="keyword">new</span> FileOutputStream(destFile);</span><br><span class="line">    <span class="keyword">byte</span>[]buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">8</span>*<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span> b;</span><br><span class="line">    <span class="keyword">while</span> ((b=in.read(buf,<span class="number">0</span>,buf.length))!=-<span class="number">1</span>)&#123;</span><br><span class="line">        out.write(buf,<span class="number">0</span>,b);</span><br><span class="line">        out.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    out.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="字符流"><a href="#字符流" class="headerlink" title="字符流"></a>字符流</h3><p><strong>操作的是文本文件</strong></p>
<ol>
<li><p>注意编码问题</p>
</li>
<li><p>认识文本和文本文件：</p>
<ul>
<li>Java的文本(char)是16位无符号整数，是字符的unicode编码(双字节编码)</li>
<li>文件是 byte,byte,byte 的数据序列</li>
<li>文本文件是文本(char)序列按照某种编码方案(utf-8,gbk)序列化为byte存储结果</li>
</ul>
</li>
<li><p>也分为Read、Writer 输入输出流，字符的底层也是字节序列</p>
</li>
<li><p>字符流的基本实现：</p>
<ul>
<li>InputStreamReader：完成byte流解析为char流，按照编码解析</li>
<li>OutputStreamWriter 提供char流到byte流，按照编码处理</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadAndWriterDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(<span class="string">"d:\\job.txt"</span>);</span><br><span class="line">        <span class="comment">//如果不设置则是默认项目编码,要写文件本身的编码</span></span><br><span class="line">        InputStreamReader reader = <span class="keyword">new</span> InputStreamReader(inputStream,<span class="string">"gbk"</span>);</span><br><span class="line">        OutputStreamWriter writer = <span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(<span class="string">"d:\\job2.txt"</span>),<span class="string">"utf-8"</span>);</span><br><span class="line"><span class="comment">//        int c;</span></span><br><span class="line"><span class="comment">//        while ((c=reader.read())!=-1)&#123;</span></span><br><span class="line"><span class="comment">//            System.out.print((char)c);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">char</span>[]buffer = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">8</span>+<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> c;</span><br><span class="line">        <span class="comment">//批量读取，放入buffe这个字符数组，从第0个位置开始，最多放buffer.lengtu个</span></span><br><span class="line">        <span class="comment">//返回的是字符个数</span></span><br><span class="line">        <span class="keyword">while</span>((c=reader.read(buffer,<span class="number">0</span>,buffer.length))!=-<span class="number">1</span>)&#123;</span><br><span class="line">            String s = <span class="keyword">new</span> String(buffer,<span class="number">0</span>,c);</span><br><span class="line">            System.out.print(s);</span><br><span class="line">            writer.write(buffer,<span class="number">0</span>,c);</span><br><span class="line">            writer.flush();</span><br><span class="line">    &#125;</span><br><span class="line">        inputStream.close();</span><br><span class="line">        writer.close();</span><br><span class="line">        reader.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>文件流：FileReader 和 FileWriter</li>
</ol>
<h3 id="对象的序列化，反序列化"><a href="#对象的序列化，反序列化" class="headerlink" title="对象的序列化，反序列化"></a>对象的序列化，反序列化</h3><ol>
<li>对象的序列化，就是将Object转换成byte序列，反之叫对象的反序列化</li>
<li>序列化流是过滤流： ObjectOutputStream.writeObject / ObjectInputStream.readObject</li>
<li>序列化接口（Serializable）<br> 对象必须实现序列化接口，才能进行序列化，否则将出现异常，这个接口没有任何方法，只是一个标识代表可序列化</li>
</ol>
<p>使用对象流进行序列化和反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        String  file = <span class="string">"d:\\Student.txt"</span>;</span><br><span class="line">        <span class="comment">//1.对象的序列化</span></span><br><span class="line"><span class="comment">//        ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(file));</span></span><br><span class="line"><span class="comment">//        Student stu = new Student(18,"Tom","man");</span></span><br><span class="line"><span class="comment">//        out.writeObject(stu);</span></span><br><span class="line"><span class="comment">//        out.close();</span></span><br><span class="line">        ObjectInputStream input = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">        Student stu = (Student) input.readObject();</span><br><span class="line">        System.out.println(stu);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用</li>
</ol>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/Java常用类库与技巧/">Java常用类库与技巧</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IO机制/">IO机制</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-J-U-C包的梳理"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/10/J-U-C包的梳理/">J.U.C包的梳理</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/10/J-U-C包的梳理/" class="article-date">
	  <time datetime="2019-11-10T12:28:36.000Z" itemprop="datePublished">November 10, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/Java多线程与并发/">Java多线程与并发</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>JUC包(java.util.concurrent)：提供了并发编程的解决方案，主要分为以下5类：</p>
<ul>
<li>线程执行器executor</li>
<li>锁locks</li>
<li>原子变量类atomic</li>
<li>并发工具类tools</li>
<li>并发容器</li>
</ul>
<p><img src="/2019/11/10/J-U-C包的梳理/JUC%E5%8C%85%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.jpg" alt></p>
<h2 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h2><hr>
<p><img src="/2019/11/10/J-U-C包的梳理/J-U-C%E5%8C%85%E7%9A%84%E6%A2%B3%E7%90%86%5CExecutor%E6%A1%86%E6%9E%B6.jpg" alt></p>
<p><strong>J.U.C的三个Executor接口</strong></p>
<ul>
<li><p><strong>Executor</strong>:运行新任务的简单接口，将任务提交和任务执行细节解耦</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//直接启动线程</span><br><span class="line">Thread t = new Thread();</span><br><span class="line">t.start();</span><br><span class="line">//交给execute</span><br><span class="line">Thread t = new Thread();</span><br><span class="line">execute.execute(t);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ExecutorService</strong>:具备管理执行器和任务生命周期的方法，提交任务机制更完善<br>例如，其中submit方法传入了Callable,弥补了Runnable无法返回结果的短板，因此较Executor提供了更加完善的提交机制</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ScheduledExecutorService</strong>:扩展了ExecutorService，同时支持Future和定期执行任务</p>
</li>
</ul>
<h2 id="Atomic-原子类"><a href="#Atomic-原子类" class="headerlink" title="Atomic 原子类"></a>Atomic 原子类</h2><hr>
<p>其中 CAS 是java.util.concurrent.atomic包的基础</p>
<p><strong>基本类型</strong></p>
<p>使用原子的方式更新基本类型</p>
<ul>
<li>AtomicInteger：整形原子类</li>
<li>AtomicLong：长整型原子类</li>
<li>AtomicBoolean：布尔型原子类</li>
</ul>
<p><strong>数组类型</strong></p>
<p>使用原子的方式更新数组里的某个元素</p>
<ul>
<li>AtomicIntegerArray：整形数组原子类</li>
<li>AtomicLongArray：长整形数组原子类</li>
<li>AtomicReferenceArray：引用类型数组原子类</li>
</ul>
<p><strong>引用类型</strong></p>
<p>使用原子的方式更新数组里的某个元素</p>
<ul>
<li>AtomicReference：引用类型原子类</li>
<li>AtomicStampedReference：原子更新引用类型里的字段原子类</li>
<li>AtomicMarkableReference ：原子更新带有标记位的引用类型</li>
</ul>
<p><strong>对象的属性修改类型</strong></p>
<ul>
<li>AtomicIntegerFieldUpdater：原子更新整形字段的更新器</li>
<li>AtomicLongFieldUpdater：原子更新长整形字段的更新器</li>
<li>AtomicStampedReference：原子更新带有版本号的引用类型。该类将整数值与引用关联起来，可用于解决原子的更新数据和数据的版本号，可以解决使用 CAS 进行原子更新时可能出现的 ABA 问题。</li>
</ul>
<h3 id="AtomicInteger-的使用"><a href="#AtomicInteger-的使用" class="headerlink" title="AtomicInteger 的使用"></a>AtomicInteger 的使用</h3><p><strong>AtomicInteger 类常用方法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final int get() //获取当前的值</span><br><span class="line">public final int getAndSet(int newValue)//获取当前的值，并设置新的值</span><br><span class="line">public final int getAndIncrement()//获取当前的值，并自增</span><br><span class="line">public final int getAndDecrement() //获取当前的值，并自减</span><br><span class="line">public final int getAndAdd(int delta) //获取当前的值，并加上预期的值</span><br><span class="line">boolean compareAndSet(int expect, int update) //如果输入的数值等于预期值，则以原子方式将该值设置为输入值（update）</span><br><span class="line">public final void lazySet(int newValue)//最终设置为newValue,使用 lazySet 设置之后可能导致其他线程在之后的一小段时间内还是可以读到旧的值。</span><br></pre></td></tr></table></figure>

<p><strong>AtomicInteger 类的使用示例</strong><br>使用 AtomicInteger 之后，不用对 increment() 方法加锁也可以保证线程安全。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class AtomicIntegerTest &#123;</span><br><span class="line">        private AtomicInteger count = new AtomicInteger();</span><br><span class="line">      //使用AtomicInteger之后，不需要对该方法加锁，也可以实现线程安全。</span><br><span class="line">        public void increment() &#123;</span><br><span class="line">                  count.incrementAndSet();</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">       public int getCount() &#123;</span><br><span class="line">                return count.get();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AtomicInteger-类的原理"><a href="#AtomicInteger-类的原理" class="headerlink" title="AtomicInteger 类的原理"></a>AtomicInteger 类的原理</h3><p>AtomicInteger 线程安全原理简单分析</p>
<p>AtomicInteger 类的部分源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// setup to use Unsafe.compareAndSwapInt for updates（更新操作时提供“比较并替换”的作用）</span><br><span class="line">   private static final Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line">   private static final long valueOffset;</span><br><span class="line"></span><br><span class="line">   static &#123;</span><br><span class="line">       try &#123;</span><br><span class="line">           valueOffset = unsafe.objectFieldOffset</span><br><span class="line">               (AtomicInteger.class.getDeclaredField(&quot;value&quot;));</span><br><span class="line">       &#125; catch (Exception ex) &#123; throw new Error(ex); &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   private volatile int value;</span><br></pre></td></tr></table></figure>

<p>AtomicInteger 类主要利用 CAS (compare and swap) + volatile 和 native 方法来保证原子操作，从而避免 synchronized 的高开销，执行效率大为提升。</p>
<p>CAS的原理是拿期望的值和原本的一个值作比较，如果相同则更新成新的值。UnSafe 类的 objectFieldOffset() 方法是一个本地方法，这个方法是用来拿到“原来的值”的内存地址，返回值是 valueOffset。另外 value 是一个volatile变量，在内存中可见，因此 JVM 可以保证任何时刻任何线程总能拿到该变量的最新值。</p>
<h2 id="并发工具类"><a href="#并发工具类" class="headerlink" title="并发工具类"></a>并发工具类</h2><hr>
<p>AQS 是java.util.concurrent.locks包以及一些常用类比如：Semophore,ReentrantLock类的基础</p>
<ul>
<li><p>Semaphore(信号量)-允许多个线程同时访问： synchronized 和 ReentrantLock 都是一次只允许一个线程访问某个资源，Semaphore(信号量)可以指定多个线程同时访问某个资源。</p>
<p><img src="/2019/11/10/J-U-C包的梳理/Semaphore.jpg" alt></p>
</li>
<li><p>CountDownLatch （倒计时器）： CountDownLatch是一个同步工具类，用来协调多个线程之间的同步。这个工具通常用来控制线程等待，它可以让某一个线程等待直到倒计时结束，再开始执行。</p>
</li>
</ul>
<p><img src="/2019/11/10/J-U-C包的梳理/CountDownLatch.jpg" alt></p>
<ul>
<li><p>CyclicBarrier(循环栅栏)： CyclicBarrier 和 CountDownLatch 非常类似，它也可以实现线程间的技术等待，但是它的功能比 CountDownLatch 更加复杂和强大。主要应用场景和 CountDownLatch 类似。CyclicBarrier 的字面意思是可循环使用（Cyclic）的屏障（Barrier）。它要做的事情是，让一组线程到达一个屏障（也可以叫同步点）时被阻塞，直到最后一个线程到达屏障时，屏障才会开门，所有被屏障拦截的线程才会继续干活。</p>
<p><img src="/2019/11/10/J-U-C包的梳理/CyclicBarrier.jpg" alt></p>
</li>
<li><p>CyclicBarrier默认的构造方法是 CyclicBarrier(int parties)，其参数表示屏障拦截的线程数量，每个线程调用await()方法告诉 CyclicBarrier 我已经到达了屏障，然后当前线程被阻塞。</p>
</li>
<li><p>交换器 Exchanger</p>
<p><img src="/2019/11/10/J-U-C包的梳理/Exchanger.jpg" alt></p>
</li>
</ul>
<h2 id="并发容器"><a href="#并发容器" class="headerlink" title="并发容器"></a>并发容器</h2><hr>
<p>JDK提供的这些容器大部分在 java.util.concurrent 包中。</p>
<ul>
<li>ConcurrentHashMap: 线程安全的HashMap</li>
<li>CopyOnWriteArrayList: 线程安全的List，在读多写少的场合性能非常好，远远好于Vector.</li>
<li>ConcurrentLinkedQueue: 高效的并发队列，使用链表实现。可以看做一个线程安全的 LinkedList，这是一个非阻塞队列。</li>
<li>BlockingQueue: 这是一个接口，JDK内部通过链表、数组等方式实现了这个接口。表示阻塞队列，非常适合用于作为数据共享的通道。</li>
<li>ConcurrentSkipListMap: 跳表的实现。这是一个Map，使用跳表的数据结构进行快速查找</li>
</ul>
<h3 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h3><p>ConcurrentHashMap 的诞生。在ConcurrentHashMap中，无论是读操作还是写操作都能保证很高的性能：在进行读操作时(几乎)不需要加锁，而在写操作时通过锁分段技术只对所操作的段加锁而不影响客户端对其它段的访问。</p>
<p>以下两各问题在 ConcurrentHashMap 有专门的讲解</p>
<ul>
<li>ConcurrentHashMap 和 Hashtable 的区别</li>
<li>ConcurrentHashMap线程安全的具体实现方式/底层具体实现</li>
</ul>
<h3 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h3><p>提供可阻塞的入队和出队操作</p>
<p>主要用于生产者-消费者问题中，其原因是BlockingQueue提供了可阻塞的插入和移除的方法。当队列容器已满，生产者线程会被阻塞，直到队列未满；当队列容器为空时，消费者线程会被阻塞，直至队列非空时为止。</p>
<p>在多线程场景时生产者线程在队列尾部添加元素，而消费者线程在队列头部消费元素，通过这种方式能够达到将任务的生产和消费进行隔离的目的</p>
<p> <img src="/2019/11/10/J-U-C包的梳理/BlockingQueue.jpg" alt></p>
<p>由以下七个实现类， 都是线程安全</p>
<p><img src="/2019/11/10/J-U-C包的梳理/BlockingQueue%E5%AD%90%E7%B1%BB.jpg" alt></p>
<p><strong>下面主要介绍一下:ArrayBlockingQueue、LinkedBlockingQueue、PriorityBlockingQueue，这三个 BlockingQueue 的实现类。</strong></p>
<h4 id="ArrayBlockingQueue"><a href="#ArrayBlockingQueue" class="headerlink" title="ArrayBlockingQueue"></a>ArrayBlockingQueue</h4><p><strong>ArrayBlockingQueue</strong> 是 BlockingQueue 接口的有界队列实现类，底层采用<strong>数组</strong>来实现。ArrayBlockingQueue一旦创建，容量不能改变。其并发控制采用可重入锁来控制，不管是插入操作还是读取操作，都需要获取到锁才能进行操作。当队列容量满时，尝试将元素放入队列将导致操作阻塞;尝试从一个空队列中取一个元素也会同样阻塞。</p>
<p>ArrayBlockingQueue 默认情况下不能保证线程访问队列的公平性，所谓公平性是指严格按照线程等待的绝对时间顺序，即最先等待的线程能够最先访问到 ArrayBlockingQueue。而非公平性则是指访问 ArrayBlockingQueue 的顺序不是遵守严格的时间顺序，有可能存在，当 ArrayBlockingQueue 可以被访问时，长时间阻塞的线程依然无法访问到 ArrayBlockingQueue。如果保证公平性，通常会降低吞吐量。如果需要获得公平性的 ArrayBlockingQueue，可采用如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static ArrayBlockingQueue&lt;Integer&gt; blockingQueue = new ArrayBlockingQueue&lt;Integer&gt;(10,true);</span><br></pre></td></tr></table></figure>

<h4 id="LinkedBlockingQueue"><a href="#LinkedBlockingQueue" class="headerlink" title="LinkedBlockingQueue"></a>LinkedBlockingQueue</h4><p><strong>LinkedBlockingQueue</strong> 底层基于<strong>单向链表</strong>实现的阻塞队列，可以当做无界队列也可以当做有界队列来使用，同样满足FIFO的特性，与ArrayBlockingQueue 相比起来具有更高的吞吐量，为了防止 LinkedBlockingQueue 容量迅速增，损耗大量内存。通常在创建LinkedBlockingQueue 对象时，会指定其大小，如果未指定，容量等于Integer.MAX_VALUE。</p>
<h4 id="PriorityBlockingQueue"><a href="#PriorityBlockingQueue" class="headerlink" title="PriorityBlockingQueue"></a>PriorityBlockingQueue</h4><p><strong>PriorityBlockingQueue</strong> 是一个支持优先级的无界阻塞队列。默认情况下元素采用自然顺序进行排序，也可以通过自定义类实现 compareTo() 方法来指定元素排序规则，或者初始化时通过构造器参数 Comparator 来指定排序规则。</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/Java多线程与并发/">Java多线程与并发</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Executor/">Executor</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JUC包的梳理/">JUC包的梳理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发容器/">并发容器</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/">Next</a>
  </nav>

</section>
          <aside id="sidebar">
  
    <div style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 72%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 36px; width: 100%;" placeholder=" Search…" value="" name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="Search">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Connect With Us</h3>
    <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
   			<li><a href="https://github.com/ValarMorghulis521" title="Github"><i class="fa fa-github" aria-hidden="true"></i></a></li> 

   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a></li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>
		</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>Recent Posts</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2020/04/20/链表/">链表</a></h6>
              <span>April 20, 2020</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2020/04/18/稀疏数组和队列/">稀疏数组和队列</a></h6>
              <span>April 18, 2020</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2020/04/18/数据结构和算法概述/">数据结构和算法概述</a></h6>
              <span>April 18, 2020</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2020/03/17/消息队列总结/">消息队列总结</a></h6>
              <span>March 17, 2020</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2020/02/29/SpringMVC/">SpringMVC</a></h6>
              <span>February 29, 2020</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2020/01/04/Java基础总结/">Java基础总结</a></h6>
              <span>January 4, 2020</span>
            </div>

          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GC相关/">GC相关</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java多线程与并发/">Java多线程与并发</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java常用类库与技巧/">Java常用类库与技巧</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Boot-实战/">Spring Boot 实战</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器/">容器</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开发工具/">开发工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务实战/">微服务实战</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构和算法/">数据结构和算法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据通信/">数据通信</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ACID/">ACID</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOF/">AOF</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/">AOP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ArrayList/">ArrayList</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ClassLoader/">ClassLoader</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ConcurrentHashMap/">ConcurrentHashMap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Config-Clent/">Config Clent</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Config-Server/">Config Server</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cookie和动态路由/">Cookie和动态路由</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Eureka/">Eureka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Executor/">Executor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashMap/">HashMap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hashtable/">Hashtable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hystrix/">Hystrix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IOC/">IOC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO机制/">IO机制</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/InnoDB/">InnoDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JUC包的梳理/">JUC包的梳理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM内存结构模型/">JVM内存结构模型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java特性/">Java特性</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/List/">List</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MVC/">MVC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyISAM/">MyISAM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OSI七层模型/">OSI七层模型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RDB/">RDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RTO/">RTO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RTT/">RTT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/">RabbitMQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Set/">Set</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cliud-Stream/">Spring Cliud Stream</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud-Bus/">Spring Cloud Bus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud-Sleuth/">Spring Cloud Sleuth</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP的三次握手/">TCP的三次握手</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP的四次挥手/">TCP的四次挥手</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Thread和Runnable/">Thread和Runnable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UDP/">UDP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zipkin/">Zipkin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zuul/">Zuul</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interrupt/">interrupt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lombok/">lombok</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/notify/">notify</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql调优/">sql调优</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/start和run/">start和run</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yield/">yield</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/代理模式/">代理模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式锁/">分布式锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单例模式/">单例模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单链表/">单链表</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/双向链表/">双向链表</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/反射/">反射</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/回收算法/">回收算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多路I-O复用模型/">多路I/O复用模型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/密集索引/">密集索引</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工厂模式/">工厂模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/平台无关性/">平台无关性</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发容器/">并发容器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异常/">异常</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异步队列/">异步队列</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/当前读/">当前读</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/快照读/">快照读</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库事务/">数据库事务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库架构/">数据库架构</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数组/">数组</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/新生代垃圾收集器/">新生代垃圾收集器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日志框架/">日志框架</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/服务容错/">服务容错</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/服务网关/">服务网关</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/标记算法/">标记算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/滑动窗口/">滑动窗口</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/稀疏索引/">稀疏索引</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/类的装载/">类的装载</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/索引/">索引</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/索引数据结构/">索引数据结构</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线程共享/">线程共享</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线程独占/">线程独占</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/老年代垃圾收集器/">老年代垃圾收集器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/语法/">语法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/跨域/">跨域</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/进程和线程/">进程和线程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/鉴权/">鉴权</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/链路监控/">链路监控</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/锁模块/">锁模块</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/队列/">队列</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/限流/">限流</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ACID/" style="font-size: 10px;">ACID</a> <a href="/tags/AOF/" style="font-size: 10px;">AOF</a> <a href="/tags/AOP/" style="font-size: 10px;">AOP</a> <a href="/tags/ArrayList/" style="font-size: 10px;">ArrayList</a> <a href="/tags/ClassLoader/" style="font-size: 10px;">ClassLoader</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 10px;">ConcurrentHashMap</a> <a href="/tags/Config-Clent/" style="font-size: 10px;">Config Clent</a> <a href="/tags/Config-Server/" style="font-size: 10px;">Config Server</a> <a href="/tags/Cookie和动态路由/" style="font-size: 10px;">Cookie和动态路由</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Eureka/" style="font-size: 10px;">Eureka</a> <a href="/tags/Executor/" style="font-size: 10px;">Executor</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/HashMap/" style="font-size: 10px;">HashMap</a> <a href="/tags/Hashtable/" style="font-size: 10px;">Hashtable</a> <a href="/tags/Hystrix/" style="font-size: 10px;">Hystrix</a> <a href="/tags/IOC/" style="font-size: 10px;">IOC</a> <a href="/tags/IO机制/" style="font-size: 10px;">IO机制</a> <a href="/tags/InnoDB/" style="font-size: 10px;">InnoDB</a> <a href="/tags/JUC包的梳理/" style="font-size: 10px;">JUC包的梳理</a> <a href="/tags/JVM内存结构模型/" style="font-size: 10px;">JVM内存结构模型</a> <a href="/tags/Java特性/" style="font-size: 10px;">Java特性</a> <a href="/tags/List/" style="font-size: 10px;">List</a> <a href="/tags/MVC/" style="font-size: 10px;">MVC</a> <a href="/tags/MyISAM/" style="font-size: 10px;">MyISAM</a> <a href="/tags/OSI七层模型/" style="font-size: 10px;">OSI七层模型</a> <a href="/tags/RDB/" style="font-size: 10px;">RDB</a> <a href="/tags/RTO/" style="font-size: 10px;">RTO</a> <a href="/tags/RTT/" style="font-size: 10px;">RTT</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/Set/" style="font-size: 10px;">Set</a> <a href="/tags/Spring-Cliud-Stream/" style="font-size: 10px;">Spring Cliud Stream</a> <a href="/tags/Spring-Cloud-Bus/" style="font-size: 10px;">Spring Cloud Bus</a> <a href="/tags/Spring-Cloud-Sleuth/" style="font-size: 10px;">Spring Cloud Sleuth</a> <a href="/tags/TCP的三次握手/" style="font-size: 10px;">TCP的三次握手</a> <a href="/tags/TCP的四次挥手/" style="font-size: 10px;">TCP的四次挥手</a> <a href="/tags/Thread和Runnable/" style="font-size: 10px;">Thread和Runnable</a> <a href="/tags/UDP/" style="font-size: 10px;">UDP</a> <a href="/tags/Zipkin/" style="font-size: 10px;">Zipkin</a> <a href="/tags/Zuul/" style="font-size: 10px;">Zuul</a> <a href="/tags/interrupt/" style="font-size: 10px;">interrupt</a> <a href="/tags/lombok/" style="font-size: 10px;">lombok</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/notify/" style="font-size: 10px;">notify</a> <a href="/tags/sql调优/" style="font-size: 10px;">sql调优</a> <a href="/tags/start和run/" style="font-size: 10px;">start和run</a> <a href="/tags/yield/" style="font-size: 10px;">yield</a> <a href="/tags/代理模式/" style="font-size: 10px;">代理模式</a> <a href="/tags/分布式锁/" style="font-size: 10px;">分布式锁</a> <a href="/tags/单例模式/" style="font-size: 10px;">单例模式</a> <a href="/tags/单链表/" style="font-size: 10px;">单链表</a> <a href="/tags/双向链表/" style="font-size: 10px;">双向链表</a> <a href="/tags/反射/" style="font-size: 10px;">反射</a> <a href="/tags/回收算法/" style="font-size: 10px;">回收算法</a> <a href="/tags/多路I-O复用模型/" style="font-size: 10px;">多路I/O复用模型</a> <a href="/tags/密集索引/" style="font-size: 10px;">密集索引</a> <a href="/tags/工厂模式/" style="font-size: 10px;">工厂模式</a> <a href="/tags/平台无关性/" style="font-size: 10px;">平台无关性</a> <a href="/tags/并发容器/" style="font-size: 10px;">并发容器</a> <a href="/tags/异常/" style="font-size: 10px;">异常</a> <a href="/tags/异步队列/" style="font-size: 10px;">异步队列</a> <a href="/tags/当前读/" style="font-size: 10px;">当前读</a> <a href="/tags/快照读/" style="font-size: 10px;">快照读</a> <a href="/tags/数据库事务/" style="font-size: 10px;">数据库事务</a> <a href="/tags/数据库架构/" style="font-size: 10px;">数据库架构</a> <a href="/tags/数组/" style="font-size: 10px;">数组</a> <a href="/tags/新生代垃圾收集器/" style="font-size: 10px;">新生代垃圾收集器</a> <a href="/tags/日志框架/" style="font-size: 10px;">日志框架</a> <a href="/tags/服务容错/" style="font-size: 10px;">服务容错</a> <a href="/tags/服务网关/" style="font-size: 10px;">服务网关</a> <a href="/tags/标记算法/" style="font-size: 10px;">标记算法</a> <a href="/tags/滑动窗口/" style="font-size: 10px;">滑动窗口</a> <a href="/tags/稀疏索引/" style="font-size: 10px;">稀疏索引</a> <a href="/tags/类的装载/" style="font-size: 10px;">类的装载</a> <a href="/tags/索引/" style="font-size: 15px;">索引</a> <a href="/tags/索引数据结构/" style="font-size: 10px;">索引数据结构</a> <a href="/tags/线程共享/" style="font-size: 10px;">线程共享</a> <a href="/tags/线程独占/" style="font-size: 10px;">线程独占</a> <a href="/tags/老年代垃圾收集器/" style="font-size: 10px;">老年代垃圾收集器</a> <a href="/tags/语法/" style="font-size: 10px;">语法</a> <a href="/tags/跨域/" style="font-size: 10px;">跨域</a> <a href="/tags/进程和线程/" style="font-size: 10px;">进程和线程</a> <a href="/tags/鉴权/" style="font-size: 10px;">鉴权</a> <a href="/tags/链路监控/" style="font-size: 10px;">链路监控</a> <a href="/tags/锁模块/" style="font-size: 20px;">锁模块</a> <a href="/tags/队列/" style="font-size: 10px;">队列</a> <a href="/tags/限流/" style="font-size: 10px;">限流</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>

    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">23</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">1</span></li></ul>
    </div>

    <div>
	<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=22805088&auto=0&height=66"></iframe>
  </div>
  </div>


  
</aside>

        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2020 Contunued Story All Rights Reserved.
        
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
  </div>
</footer>


<!-- min height -->
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":true,"scale":0.5},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
